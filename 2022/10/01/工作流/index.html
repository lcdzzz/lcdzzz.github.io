<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>工作流workflow | 布鲁成周勒的博客</title><meta name="author" content="lcdzzz"><meta name="copyright" content="lcdzzz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="工作流workflow状态机解决流程问题工作流：一个可以处理复杂情况的状态机  例如，员工请假这个流程，首先员工请假提交申请，假设有项目经理进行审批，审批有两种结果：通过或者拒绝。  实现上面这个需求：  创建一张请假表，表中有员工id，请假的天数，请假的理由，项目经理的id，请假的状态sta..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "工作流workflow",
  "url": "http://lcdzzz.github.io/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/",
  "image": "https://lcdzzz.github.io/2022/10/01/gong-zuo-liu/1662298798529-e1bcda3a-42fe-4d7b-8b42-a1a38cd3c654.png",
  "datePublished": "2022-09-30T22:31:33.000Z",
  "dateModified": "2025-07-29T13:05:57.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "lcdzzz",
      "url": "http://lcdzzz.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://lcdzzz.github.io/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '工作流workflow',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://lcdzzz.github.io/2022/10/01/gong-zuo-liu/1662298798529-e1bcda3a-42fe-4d7b-8b42-a1a38cd3c654.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">布鲁成周勒的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">工作流workflow</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">工作流workflow</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-30T22:31:33.000Z" title="发表于 2022-10-01 06:31:33">2022-10-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-29T13:05:57.000Z" title="更新于 2025-07-29 21:05:57">2025-07-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">22.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>98分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="工作流workflow"><a href="#工作流workflow" class="headerlink" title="工作流workflow"></a>工作流workflow</h1><h2 id="状态机解决流程问题"><a href="#状态机解决流程问题" class="headerlink" title="状态机解决流程问题"></a>状态机解决流程问题</h2><p>工作流：一个可以处理复杂情况的状态机</p>
<blockquote>
<p>例如，员工请假这个流程，首先员工请假提交申请，假设有项目经理进行审批，审批有两种结果：通过或者拒绝。</p>
</blockquote>
<p>实现上面这个需求：</p>
<ol>
<li>创建一张请假表，表中有员工id，请假的天数，请假的理由，项目经理的id，请假的状态status</li>
<li>当员工请假的时候，就自动向这张表中添加记录</li>
<li>然后，当项目经理登录到OA的时候，就来这张表查询自己需要的请假申请，查到之后，可以选择批准或者拒绝</li>
<li>接下来，员工登录之后，就可以查到自己的请假申请的审批结果</li>
</ol>
<p>在这样的实现思路中，请假的流程我们是通过status这个字段控制的。例如：</p>
<ul>
<li>status 0 代表待审批</li>
<li>1 代表审批通过</li>
<li>2 代表拒绝</li>
</ul>
<p>上面这个例子，status就是状态码，通过这个子弹的值来控制流程的状态，这个方式我们可以称之为使用状态机来解决流程问题，但是这种思路只能解决非常简单的流程问题。</p>
<h3 id="一些复杂的流程"><a href="#一些复杂的流程" class="headerlink" title="一些复杂的流程"></a>一些复杂的流程</h3><h4 id="报销审批的流程"><a href="#报销审批的流程" class="headerlink" title="报销审批的流程"></a>报销审批的流程</h4><div style="text-align:center">
  <style>.hkpwfqnlefnz{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/%E5%AE%A1%E6%89%B9%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class="hkpwfqnlefnz">
</div>



<p>在这个流程中，已经没法使用status去描述这个报销走到哪一步了。如果非要用status，namestatus可能会有很多个取值 。</p>
<p><br><br></p>
<h4 id="笔记本电脑生产流程"><a href="#笔记本电脑生产流程" class="headerlink" title="笔记本电脑生产流程"></a>笔记本电脑生产流程</h4><div style="text-align:center">
  <style>.zlwycuvncqng{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001165041877.png" class="zlwycuvncqng" alt="image-20221001165041877">
</div>

<p>这个流程中不仅有串行任务还有并行任务,虽然技术上来说也能实现，但是如果用status字段去描述，实现起来会非常非常复杂。</p>
<h2 id="三大工作流"><a href="#三大工作流" class="headerlink" title="三大工作流"></a>三大工作流</h2><ul>
<li><p>Activiti:</p>
<p>侧重于云，即更靠拢spring cloud、docker、k8s等。</p>
</li>
<li><p>Camunada:</p>
<p>在这三个驻留的流程引擎这中，它是最轻量级的，如果我们的系统，当用户使用的过程中，需要动态的绘制流程图，那么可以使用它。这是一个小巧的工具，可以非常方便的嵌入到我们自己的系统中。它还提供了一个bpmn.js的工具，可以非常方便的实现流程图的绘制。</p>
</li>
<li><p>Flowable:</p>
<blockquote>
<p>它目前的核心思路还是做一个功能非法从完善的流程引擎工具。除了常用的最最基本的工作流之外，Flowable还提供了很多扩展点。</p>
</blockquote>
</li>
</ul>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>工作流执行的基础是流程图</p>
<p>一个完整的流程，要干嘛，先得画出来一个完整的流程图</p>
<p>上卖弄介绍了三种不同的工作流，那么三种不同的流程图绘制的方式是否一样？</p>
<p>其实，流程图的绘制，有一套统一的标准：<strong>BPMN</strong>（Business Process Model And Notation）,中文译为<strong>业务流程模型和标记法</strong>。</p>
<p>BPMN 就是一套图形化表示发，用图形来绘制、梳理业务流程模型。就是说，BPMN其实是一个非常古老的流程图规范，Activiti、Camunada、Flowable都是支持这个规范的，所以，无论使用哪一个流程图，都可以依照BPMN去绘制流程图。</p>
<p>虽然BPMN大家都支持，但是，在具体的使用细节上，不同的流程引擎还是有差别的。</p>
<h2 id="BPMN流程图怎么画"><a href="#BPMN流程图怎么画" class="headerlink" title="BPMN流程图怎么画"></a>BPMN流程图怎么画</h2><div style="text-align:center">
  <style>.benkbciipmss{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001165041877.png" class="benkbciipmss" alt="image-20221001165041877">
</div>

<p>从上图中，大致上可以归类出，流程分为：</p>
<ul>
<li>事件</li>
<li>连线</li>
<li>任务</li>
<li>网关</li>
</ul>
<h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a><strong>事件</strong></h3><p>开始事件、结束时间等等。</p>
<div style="text-align:center">
  <style>.gofbenygytcm{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001191908026.png" class="gofbenygytcm" alt="image-20221001191908026">
</div>

<p>这是我们上面用到的时间，实际上，还有很多其他类型的事件。</p>
<div style="text-align:center">
  <style>.htayqsalkzuc{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001192255139.png" class="htayqsalkzuc" alt="image-20221001192255139">
</div>



<h3 id="连线"><a href="#连线" class="headerlink" title="连线"></a><strong>连线</strong></h3><div style="text-align:center">
  <style>.jqplufsosigv{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001192542935.png" class="jqplufsosigv" alt="image-20221001192542935">
</div>

<p>连接各个不同元素之间的线条，就是连线。</p>
<p>注意：线条之上，可能会有条件。例如，在互斥网关上，满足一定条件，流程图就继续往下走；不满足条件，流程图就回到之前的某一个位置。</p>
<h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a><strong>任务</strong></h3><p>在上面的流程图，所有的矩形，都是任务，但是任务还有许多细分。</p>
<ul>
<li><p>用户任务</p>
<p>需要人工参与才能完成的工作建模。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.aheqptqfopqi{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001193913342.png" class="aheqptqfopqi" alt="image-20221001193913342">
</div>

<ul>
<li><p>服务任务</p>
<p>机器自动完成的事情，例如用户请假，经理审批通过后，想通过企业微信给用户发送一个通知，告诉他请假通过。这样的任务，就可以使用服务任务。</p>
<p>就是当流程走到这一步的时候，自动调用一个javabean，或者某一个远程服务去完成通知的发送，这是自动完成的，不需要人工介入。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.zdhkjmqohcuk{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001193929412.png" class="zdhkjmqohcuk" alt="image-20221001193929412">
</div>

<ul>
<li><p>活动</p>
<p>活动可以算是一个特殊的任务。活动之中，往往可以在活动中，调用另外一个流程使只作为当前流程的子流程去执行。活动一般又可以继续细分为用户活动、脚本活动等等。。。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.khnsqgindqsw{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001193939316.png" class="khnsqgindqsw" alt="image-20221001193939316">
</div>



<ul>
<li><p>接受任务</p>
<p>这个接受任务中，其实不需要做什么额外的事情，流程到这一步就自动停下来了，需要人工去助理一把，去推动流程继续向下走</p>
</li>
</ul>
<div style="text-align:center">
  <style>.lsgfulzlpohw{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001204055387.png" class="lsgfulzlpohw" alt="image-20221001204055387">
</div>

<ul>
<li><p>发送任务</p>
<p>将消息发送给外部的参与者。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.jlfqwnucuewm{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001204104114.png" class="jlfqwnucuewm" alt="image-20221001204104114">
</div>

<ul>
<li><p>脚本任务</p>
<p>一个自动化的活动，当流程执行到脚本任务的时候， 自动执行相应的脚本。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.ailptfjfmddf{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001204136666.png" class="ailptfjfmddf" alt="image-20221001204136666">
</div>

<ul>
<li><p>业务规则任务</p>
<p>BPMN2.0中引入的用来对接业务规则的引擎，业务规则主要用于同步执行一个或者多个规则。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.otxklhxwdeub{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001204309707.png" class="otxklhxwdeub" alt="image-20221001204309707">
</div>

<blockquote>
<p>虽然这里分类比较多，但实际上，任务主要分两种：</p>
<ol>
<li>用户任务：需要用户介入的任务。</li>
<li>服务任务：机器自动完成的任务。发送、接受、脚本等等任务，都是服务任务的细分。</li>
</ol>
</blockquote>
<br>

<h3 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h3><ul>
<li><p>互斥网关</p>
<p>可以有多个入口，但只有一个有效出口。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.kptfzgkuhbfk{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001220024468.png" class="kptfzgkuhbfk" alt="image-20221001220024468">
</div>

<ul>
<li><p>并行网关 </p>
<p>并行网关一般是成对出现的，当有并行操作的时候，可以使用并行网关。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.kixijzqflzpd{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001220035128.png" class="kixijzqflzpd" alt="image-20221001220035128">
</div>

<ul>
<li><p>相容网关</p>
<p>这种网关可能会存在多个有效的出口。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.mojhbqgngdyh{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001222051985.png" class="mojhbqgngdyh" alt="image-20221001222051985">
</div>

<ul>
<li><p>事件网关</p>
<p>通过中间事件驱动的网关。当等待的事件触发之后，才会触发决策。</p>
</li>
</ul>
<div style="text-align:center">
  <style>.rvdorhpmnrow{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221001222332184.png" class="rvdorhpmnrow" alt="image-20221001222332184">
</div>

<p><br><br></p>
<h1 id="流程图绘制"><a href="#流程图绘制" class="headerlink" title="流程图绘制"></a>流程图绘制</h1><p>IDEA 中有一个流程绘制插件 <code>flowable-bpmn-visualizer</code></p>
<p>其他的绘制工具：</p>
<ol>
<li>flowable-ui 这是官方提供的一个 flowable 的工具，里边有很多功能，包括画流程图。</li>
<li>bpmn.js 这个工具是 Camunda 提供的，可以嵌入到我们当前的项目中，利用这个 bpmn.js 可以开发一个流程绘制工具。原生的 bpmn.js 画出来的流程图只能在 Camunda 中使用，但是经过改造之后，就可以在 flowable 中使用了。</li>
</ol>
<h3 id="flowable-bpmn-visualizer"><a href="#flowable-bpmn-visualizer" class="headerlink" title="flowable-bpmn-visualizer"></a>flowable-bpmn-visualizer</h3><p>插件安装：</p>
<div style="text-align:center">
  <style>.yxfomptdkwuu{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662294964274-2b7d4e1a-7cc2-492b-8f75-359b59b44161.png" class="yxfomptdkwuu">
</div>

<br>

<p>装好之后重启 IDEA 即可。</p>
<p>在 IDEA 中，当我们安装了这个插件之后，新建文件文件的时候，就有相应的选项：</p>
<div style="text-align:center">
  <style>.cmxyubqjhnws{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662295030832-72f92789-a8ed-434d-9f82-5da06f895a3b.png" class="cmxyubqjhnws" alt="img">
</div>

<br>

<p>选择这个就可以新建一个流程图了。</p>
<div style="text-align:center">
  <style>.lbkqmulgrpkk{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662295137030-df367ca9-7e39-45a4-a7c6-699c0f551f8b.png" class="lbkqmulgrpkk" alt="img">
</div>

<br>

<p>绘制关键节点：</p>
<div style="text-align:center">
  <style>.auggfwwutrxr{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662296079769-c38bde1c-6674-4372-957d-b40d0e162940.png" class="auggfwwutrxr" alt="img">
</div>

<br>

<p>注意，这里如果是传递变量需要用 ${} 表达式</p>
<div style="text-align:center">
  <style>.xqmiwcdoblsc{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221002110125811.png" class="xqmiwcdoblsc" alt="image-20221002110125811">
</div>

<br>

<p>如果是字符串，直接写即可，例如，这个节点由一个名为 javaboy 的用户来处理，那么写法如下：</p>
<div style="text-align:center">
  <style>.mgnbuzepvfvc{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662296243537-31472336-ae7d-40fd-9c3f-2c0643e7c4b2.png" class="mgnbuzepvfvc" alt="img">
</div>

<br>

<p>注意，从排他性网关出来的线条中，有一个 Condition expression，这个表示这个线条执行的条件。以下图为例，具体来说，就是当用户在审批的时候，本质上其实就是传递一个变量，变量值为 true 或者 false。下图中的 <code>$&#123;approve&#125;</code>表示这个变量的名字为 approve。</p>
<div style="text-align:center">
  <style>.hbtaffyjuffl{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662296676030-c1f2140f-b7ce-43b4-a622-f554a22cbd07.png" class="hbtaffyjuffl" alt="img">
</div>

<br>

<p>然后再来看发邮件的服务：</p>
<p>齿轮表示这是一个服务任务，也就是系统自动完成的，系统自动完成的方式有很多种，其中一种是提前将自己的业务逻辑在 Java 类中写好，然后这里配置一下类的完整路径即可。</p>
<div style="text-align:center">
  <style>.ahkbfsisslih{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662296856230-147569d6-44f2-44c0-9412-bd6d81ceb25b.png" class="ahkbfsisslih" alt="img">
</div>

<br>

<p>下图表示的是从网关出来之后，approve 变量如果为 false，那么就进入到请求被拒绝的服务中。</p>
<div style="text-align:center">
  <style>.atpormcynook{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662297231235-9663d631-02c2-4d52-ab0c-2872a027ffcb.png" class="atpormcynook" alt="img">
</div>

<p><br><br></p>
<h3 id="flowable-ui"><a href="#flowable-ui" class="headerlink" title="flowable-ui"></a>flowable-ui</h3><p>这个是 Flowable 官方推荐的一个流程引擎辅助工具。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>有两种方式：</p>
<p>官方提供的是一个 war 包，这个虽然是一个 war 包，但是除了将之扔到 Tomcat 中去运行之外，也可以直接执行 java -jar xxx.war 这个命令去启动这个 war 包。</p>
<p>war 下载地址：<a target="_blank" rel="noopener" href="https://github.com/flowable/flowable-engine/releases/download/flowable-6.7.2/flowable-6.7.2.zip">https://github.com/flowable/flowable-engine/releases/download/flowable-6.7.2/flowable-6.7.2.zip</a>.   这个 zip 包下载之后，里边有一个 wars 文件夹，里边包含了 flowable-ui 的 war 包。然后，就像启动 Spring Boot 一样，直接启动这个 war 包即可：</p>
<p>文件位置：</p>
<div style="text-align:center">
  <style>.bkuzgslxudic{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662299006224-ec838dd9-5210-4a3b-b222-a8b847bceedd.png" class="bkuzgslxudic" alt="img">
</div>

<p>启动命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar flowable-ui.war</span><br></pre></td></tr></table></figure>

<div style="text-align:center">
  <style>.djcsfyhapooy{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662298727856-85e07052-d98b-4f23-858c-03fc41bc9733.png" class="djcsfyhapooy" alt="img">
</div>

<p>启动之后，默认的端口号是 8080。</p>
<p>启动之后，浏览器输入 <a target="_blank" rel="noopener" href="http://localhost:8080/flowable-ui/idm/#/login">http://localhost:8080/flowable-ui/idm/#/login</a>.   如果看到如下页面，表示启动成功：</p>
<div style="text-align:center">
  <style>.gitmcnkowpuv{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662298798529-e1bcda3a-42fe-4d7b-8b42-a1a38cd3c654.png" class="gitmcnkowpuv" alt="img">
</div>

<br>



<p>另外，我们也可以使用 docker 来安装，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8086:8080 -d  flowable/flowable-ui</span><br></pre></td></tr></table></figure>

<div style="text-align:center">
  <style>.pfupysgebcph{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662298930060-f28c448e-ee5f-4b7a-b707-08e860bfcc9f.png" class="pfupysgebcph" alt="img">
</div>



<p>最后访问<a target="_blank" rel="noopener" href="http://localhost:8086/flowable-ui">http://localhost:8086/flowable-ui</a></p>
<br>

<h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><p>默认的登录用户名是 admin，默认的登录密码是 test。</p>
<p>看到如下页面，表示登录成功。</p>
<div style="text-align:center">
  <style>.mpoexpshtqsm{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662299436621-78863134-877b-4823-910c-dceaed48ca92.png" class="mpoexpshtqsm" alt="img">
</div>

<br>

<h4 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h4><p>flowable-ui 是完整的 flowable 体验 DEMO，而不仅仅只是一个流程图的绘制工具。所以它里边不仅可以画流程图，还可以运行流程图，既然能够运行流程图，那么就需要身份管理。</p>
<ol>
<li>任务应用程序：我们绘制好的流程图，可以直接将之发布到一个应用中，然后在这里进行部署，这个模块其实就是这些部署的应用程序。</li>
<li>建模器应用程序：这个专门用来画流程图的。</li>
<li>管理员应用程序：这个主要用来管理应用，一些具有管理员权限的用户，可以通过这个功能模块去查询 BPMN、DMN、FORM 等等信息。</li>
<li>身份管理应用程序：这个功能模块，为所有的 flowable-ui 应用程序提供一个单点登录功能，并且还可以为这些用户设置用户组、用户权限等。</li>
</ol>
<h4 id="身份管理应用程序"><a href="#身份管理应用程序" class="headerlink" title="身份管理应用程序"></a>身份管理应用程序</h4><p>创建用户流程：</p>
<div style="text-align:center">
  <style>.hymviypbkmlh{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662300290889-a1a5a2c7-2c96-44be-888e-e03ffa2043df.png" class="hymviypbkmlh" alt="img">
</div>

<p>填入用户的基本信息，点击保存按钮，就可以完成用户的创建了。</p>
<div style="text-align:center">
  <style>.rdkirshsxqqc{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662300273742-c44a1c1a-6c1b-41c4-8488-cdac32adaae7.png" class="rdkirshsxqqc" alt="img">
</div>

<p>新建的用户不属于任何用户组，所以这个新建的用户是没有权限的，我们现在就可以使用这个新建的用户登录，但是登录成功后，看不到任何功能模块。</p>
<p>用户创建成功之后，可以点击上面的用户组功能，创建用户组：</p>
<div style="text-align:center">
  <style>.tycvxmrsbpnk{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662300480094-5eea4abc-3381-46ca-9d51-1f29e1d09d6b.png" class="tycvxmrsbpnk" alt="img">
</div>

<p>将来我们在画流程图的时候，可以设置某一个 UserTask 由某一个用户组来处理，这个用户组中的所有用户，将来都可以处理这个 UserTask。</p>
<p>组创建成功之后，可以为这个组添加用户：</p>
<div style="text-align:center">
  <style>.togekdirhxkv{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662300644651-cb9041e4-505d-4002-a696-bbc9d7532801.png" class="togekdirhxkv" alt="img">
</div>

<p>最后，我们可以在权限控制中，为用户或者用户组添加相应的权限。</p>
<div style="text-align:center">
  <style>.nhpqsvgleily{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662300716240-b09dbf5d-3c9a-48aa-8b3c-4986b6c5a34d.png" class="nhpqsvgleily" alt="img">
</div>

<ul>
<li>访问 idm 应用：访问功能4.</li>
<li>访问 admin 应用：访问功能3。</li>
<li>访问 modeler 应用：访问功能2.</li>
<li>访问 workflow 应用：访问功能1.</li>
<li>访问 REST API：访问 REST API 接口的。</li>
</ul>
<br>

<h4 id="管理员应用程序"><a href="#管理员应用程序" class="headerlink" title="管理员应用程序"></a>管理员应用程序</h4><div style="text-align:center">
  <style>.biaponvhrqln{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662300987836-185b34ed-4314-41ff-839b-967cb2ca1d2b.png" class="biaponvhrqln" alt="img">
</div>



<br>

<h4 id="建模器应用程序"><a href="#建模器应用程序" class="headerlink" title="建模器应用程序"></a>建模器应用程序</h4><p>核心功能，主要就是画流程图。</p>
<p>绘制一个报销流程图，大致流程：</p>
<ol>
<li><p>启动一个流程。</p>
</li>
<li><p>执行一个用户任务，这个用户任务交给流程的启动人去执行。这个用户任务中，填入报销材料，例如用户名、金额、用途。</p>
</li>
<li><p>系统自动判断一下&#x2F;或者人工判断报销金额是否大于 1000。</p>
</li>
<li><p>如果报销金额小于等于 1000，那么这个报销任务交给 组长审批：</p>
</li>
<li><ol>
<li>组长审批通过，则流程结束。</li>
<li>组长审批不通过，则流程回到第 2 步，用户重新去填写报销资料。</li>
</ol>
</li>
<li><p>如果报销金额大于 1000，那么这个报销任务先交给经理审批：</p>
</li>
<li><ol>
<li>经理审批通过，则交给 CEO 审批：</li>
</ol>
</li>
<li><ol>
<li><ol>
<li>CEO 审批通过，流程结束。</li>
<li>CEO 审批不通过，流程回到步骤 2 中。</li>
</ol>
</li>
</ol>
</li>
<li><ol>
<li>经理审批不通过，则流程回到步骤 2 中。</li>
</ol>
</li>
</ol>
<h5 id="绘制流程"><a href="#绘制流程" class="headerlink" title="绘制流程"></a>绘制流程</h5><p>首先创建一个流程：</p>
<div style="text-align:center">
  <style>.feosxjbfoqzh{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662974366549-c5953cb9-61fb-4637-bce9-1abac14ec59b.png" class="feosxjbfoqzh" alt="img">
</div>

<p><strong>注意，模型的 key 在当前应用中必须是唯一的，将来我们通过 Java 代码去操作这个模型的时候，就是通过模型 key 去识别这个模型。</strong></p>
<p>绘制出来的流程图：</p>
<div style="text-align:center">
  <style>.ivemtmuynuaq{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662974845068-68dfa88a-9c02-4439-a810-0a3c96f40b1e.png" class="ivemtmuynuaq" alt="img">
</div>

<p><strong>注意，在一个流程图中，开始节点必须有且只有一个，结束节点可以有多个。</strong></p>
<h5 id="表单问题"><a href="#表单问题" class="headerlink" title="表单问题"></a>表单问题</h5><p>在流程中，传递流程参数有两种方式：</p>
<ul>
<li>流程变量。</li>
<li>表单。</li>
</ul>
<p>这两种方式都可以传递参数，区别在于，流程变量是零散的，而表单是整的。</p>
<p>对于通过表单传递的参数，我们也可以按照流程变量的方式去访问单个的表单参数，例如在上面的流程图中，我们有 <code>$&#123;money &lt;= 1000&#125;</code>，这里的 money 实际上是表单中的参数，但是我们可以直接通过 $ 表达式去访问。还有如 <code>$&#123;managers_approve_or_reject_radio_button==&quot;拒绝&quot;&#125;</code>，也是直接访问表单中的变量。</p>
<h5 id="任务处理人"><a href="#任务处理人" class="headerlink" title="任务处理人"></a>任务处理人</h5><p>对于一个 UserTask 而言，任务处理人有四种：</p>
<div style="text-align:center">
  <style>.qtlokjnclmho{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1662979177748-04931632-b328-476c-b828-44b01d408f5d.png" class="qtlokjnclmho" alt="img">
</div>

<ul>
<li>流程发起人，由流程的启动人&#x2F;发起人来处理这个流程。</li>
<li>单个用户，直接指定某一个具体的用户来处理这个流程，注意这里只能指定一个用户，并且这个用户将来在处理任务的时候，不需要认领，直接就可以处理。</li>
<li>候选用户：可以同时指定多个用户来处理这个 UserTask，将来用户在处理的时候，需要先认领（Claim）任务，然后才能处理。</li>
<li>候选组：可以同时指定多个用户组来处理这个 UserTask，这个处理的时候，也需要先认领，再处理。</li>
</ul>
<h5 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h5><ul>
<li>流程定义（ProcessDefinition）：我们绘制的流程图、流程的 XML 文件，就是我们的流程定义。</li>
<li>流程（ProcessInstance）：一个启动了流程实例就是一个流程，流程可以是已经执行完毕的，也可以是正在执行中的。流程的定义相当于是一个类，而流程则相当于是一个对象。</li>
<li>任务（Task）：一个 ProcessInstance 中，需要具体处理的节点就是一个任务。</li>
</ul>
<br>

<h4 id="任务应用程序"><a href="#任务应用程序" class="headerlink" title="任务应用程序"></a>任务应用程序</h4><p>在 flowable-ui 中，绘制好的流程图，可以直接部署称为一个 App。</p>
<h1 id="Flowable-源码编译"><a href="#Flowable-源码编译" class="headerlink" title="Flowable 源码编译"></a>Flowable 源码编译</h1><p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/flowable/flowable-engine">https://github.com/flowable/flowable-engine</a><br>编译的步骤：<br>1clone 代码： git clone <a href="mailto:&#103;&#105;&#116;&#x40;&#103;&#x69;&#x74;&#104;&#x75;&#98;&#46;&#99;&#x6f;&#109;">git@github.com</a>:flowable&#x2F;flowable-engine.gi</p>
<p>2切换分支 git checkout -b origin&#x2F;6.7.2切换到 6.7.2 这个版本。</p>
<p>先来看下源码的目录结构：</p>
<ul>
<li><p>LICENSE：开源协议</p>
</li>
<li><p>README.md：flowable 介绍文档。</p>
</li>
<li><p>distro：主要是保存了不同环境下的信息。</p>
</li>
<li><p>docker：将 flowable 构建成 docker 镜像的脚本。</p>
</li>
<li><p>docs：flowable 的文档。</p>
</li>
<li><p>ide-settings：这是如果想在 Eclipse 或者 IDEA 中快速使用 flowable 时候的配置。</p>
</li>
<li><p>k8s：flowable 支持 k8s 的一些脚本和配置。</p>
</li>
<li><p>modules：flowable 中所有的核心功能代码都在这个里边。</p>
</li>
<li><p>pom.xml：maven 的坐标文件。</p>
</li>
<li><p>qa：提供了很多各种各样的配置模版，例如如果我们需要在传统的 SSM 中配置 flowable，配置文件可以直接参考 qa 中的，但是我们现在主要是 Spring Boot 开发，在 Spring Boot 中，基本上用不到 qa 中的配置模版。</p>
</li>
<li><p>scripts：这个目录下放了常用的脚本文件。</p>
</li>
<li><p>tooling：这个目录中列出来了单元测试的模版。</p>
</li>
</ul>
<p>项目编译要点：</p>
<ol>
<li><p>用 IDEA 打开项目。在 IDEA 中，直接 open 源码即可，不需要 Import Project。</p>
</li>
<li><p>由于 IDEA 无法识别出所有的 Maven 工程，查看是否识别出来 Maven 工程的方式：（pom.xml 文件是蓝色的，或者工程名加粗了），如果有 IDEA 未识别出来的 Maven 工程，都需要挨个手动添加，添加方式就是打开项目的 pom.xml 文件，右键单击，选择 Add as Maven Project。</p>
</li>
<li><p>对于 Maven 工程，IDEA 会自动去下载所需要的依赖，但是由于这里需要下载的依赖比较多，所以下载的时候比较费时间，耐心等一下。最终也有可能会下载失败：i：先去本地 Maven 仓库，搜索以 .lastupdated结尾的文件，并删除。</p>
</li>
</ol>
<div style="text-align:center">
  <style>.djvcrbxcxrey{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1663501393227-89768ba1-e7e9-419c-9c5d-2603e7b8687e.png" class="djvcrbxcxrey" alt="img">
</div>
   2. 然后再去项目中，重新导入依赖。
<div style="text-align:center">
  <style>.itmmqvlsnuys{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1663501440148-348f0606-ae72-4dcc-aad1-79f402202d79.png" class="itmmqvlsnuys" alt="img">
</div>

<p>ii：如果前面步骤不管用，那么就去 settings.xml 文件中，修改远程仓库地址，切换为 阿里云或者华为云等提供的镜像站，<strong>然后再重新导入。</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- mirror</span></span><br><span class="line"><span class="comment">   | Specifies a repository mirror site to use instead of a given repository. The repository that</span></span><br><span class="line"><span class="comment">   | this mirror serves has an ID that matches the mirrorOf element of this mirror. IDs are used</span></span><br><span class="line"><span class="comment">   | for inheritance and direct lookup purposes, and must be unique across the set of mirrors.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">  &lt;mirror&gt;</span></span><br><span class="line"><span class="comment">    &lt;id&gt;mirrorId&lt;/id&gt;</span></span><br><span class="line"><span class="comment">    &lt;mirrorOf&gt;repositoryId&lt;/mirrorOf&gt;</span></span><br><span class="line"><span class="comment">    &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;</span></span><br><span class="line"><span class="comment">    &lt;url&gt;http://my.repository.com/repo/path&lt;/url&gt;</span></span><br><span class="line"><span class="comment">  &lt;/mirror&gt;</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>        </span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="H2-数据库"><a href="#H2-数据库" class="headerlink" title="H2 数据库"></a>H2 数据库</h3><ol>
<li>Java 编写的数据库。</li>
<li>可以基于内存来使用。</li>
<li>也可以基于文件，基于文件，类似于移动端的 Sqlite。</li>
</ol>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><p>依赖</p>
<p>除去springboot的一些基本依赖外，还要有mysql驱动</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.flowable<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flowable-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">wqeq</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql:///flowable_idm?serverTimezone=Asia/Shanghai&amp;userSSL=false&amp;nullCatalogMeansCurrent=true</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="attr">logging.level.org.flowable</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure>



<h2 id="用户操作"><a href="#用户操作" class="headerlink" title="用户操作"></a>用户操作</h2><p>事先准备号service类和log</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * IdentityService 专门负责和用户相关的操作，例如添加、删除、修改用户和用户组等</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   IdentityService identityService;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(FlowableIdmApplicationTests.class);</span><br></pre></td></tr></table></figure>





<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//创建一个用户对象</span></span><br><span class="line">       <span class="type">UserEntityImpl</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEntityImpl</span>();</span><br><span class="line">       user.setId(<span class="string">&quot;lcdzzz&quot;</span>);</span><br><span class="line">       user.setDisplayName(<span class="string">&quot;隆成&quot;</span>);</span><br><span class="line">       user.setEmail(<span class="string">&quot;1473220685@qq.com&quot;</span>);</span><br><span class="line">       user.setFirstName(<span class="string">&quot;mou&quot;</span>);</span><br><span class="line">       user.setLastName(<span class="string">&quot;zhou&quot;</span>);</span><br><span class="line">       user.setPassword(<span class="string">&quot;wqeq&quot;</span>);</span><br><span class="line">       <span class="comment">//注意：如果是添加用户，一定要加revision属性为0，表示当前用户是一个新的用户 而不是更新的用户</span></span><br><span class="line">       <span class="comment">// flowable的用户表使用了乐观锁，而Revision字段其实就是配合乐观锁使用的</span></span><br><span class="line">       user.setRevision(<span class="number">0</span>);</span><br><span class="line">       <span class="comment">//保存一个用户</span></span><br><span class="line">       <span class="comment">//这里是有两方面的功能</span></span><br><span class="line">       <span class="comment">//1. 如果用户已经存在则更新</span></span><br><span class="line">       <span class="comment">//2. 如果用户不存在则添加</span></span><br><span class="line">       identityService.saveUser(user);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新用户信息</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * saveUser方法可以用来更新用户信息，但是不可以用来更新密码</span></span><br><span class="line"><span class="comment"> * 每更新一次，数据库的reversion会自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">UserEntityImpl</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEntityImpl</span>();</span><br><span class="line">    user.setId(<span class="string">&quot;lcdzzz&quot;</span>);</span><br><span class="line">    user.setDisplayName(<span class="string">&quot;隆成典周&quot;</span>);</span><br><span class="line">    user.setEmail(<span class="string">&quot;6666@qq.com&quot;</span>);</span><br><span class="line">    <span class="comment">//注意 修改的时候 需要确保reversion的版本号和数据库的版本号保持一致</span></span><br><span class="line">    user.setRevision(<span class="number">2</span>);</span><br><span class="line">    identityService.saveUser(user);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 <br>

<p>但是每次user.setRevision(2);是写死的，所以我们可以这么写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">lcdzzz</span> <span class="operator">=</span> identityService.createUserQuery().userId(<span class="string">&quot;lcdzzz&quot;</span>).singleResult();</span><br><span class="line">    lcdzzz.setEmail(<span class="string">&quot;123321@qq.com&quot;</span>);</span><br><span class="line">    identityService.saveUser(lcdzzz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>上面的方法无法连着密码一起更新，所以可以<code>updateUserPassword</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test03</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">lcdzzz</span> <span class="operator">=</span> identityService.createUserQuery().userId(<span class="string">&quot;lcdzzz&quot;</span>).singleResult();</span><br><span class="line">    lcdzzz.setEmail(<span class="string">&quot;123321@qq.com&quot;</span>);</span><br><span class="line">    lcdzzz.setPassword(<span class="string">&quot;888&quot;</span>);</span><br><span class="line">    <span class="comment">//修改用户密码需要调用updateUserPassword这个方法，而且这个方法也能修改用户的其他属性</span></span><br><span class="line">    identityService.updateUserPassword(lcdzzz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test04</span><span class="params">()</span> &#123;</span><br><span class="line">    identityService.deleteUser(<span class="string">&quot;lcdzzz&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test07</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; email = identityService.createNativeUserQuery().sql(<span class="string">&quot;select * from ACT_ID_USER where EMAIL_=#&#123;email&#125;&quot;</span>).parameter(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;javaboy@qq.com&quot;</span>).list();</span><br><span class="line">    email.stream().forEach(i -&gt; logger.info(<span class="string">&quot;id:&#123;&#125;;display:&#123;&#125;&quot;</span>, i.getId(), i.getDisplayName()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//根据id排序，并查询所有用户</span></span><br><span class="line">    List&lt;User&gt; list = identityService.createUserQuery().orderByUserId().desc().list();</span><br><span class="line">    list.stream().forEach(i -&gt; logger.info(<span class="string">&quot;id:&#123;&#125;;display:&#123;&#125;&quot;</span>, i.getId(), i.getDisplayName()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test05</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; list = identityService.createUserQuery().userDisplayName(<span class="string">&quot;%zhang%&quot;</span>).list();</span><br><span class="line">    list.stream().forEach(i -&gt; logger.info(<span class="string">&quot;id:&#123;&#125;;display:&#123;&#125;&quot;</span>, i.getId(), i.getDisplayName()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="用户组操作"><a href="#用户组操作" class="headerlink" title="用户组操作"></a>用户组操作</h2><h3 id="增-1"><a href="#增-1" class="headerlink" title="增"></a>增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 用户组操作的表是ACT_ID_GROUP</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 具体执行的SQL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * inserting: org.flowable.idm.engine.impl.persistence.entity.GroupEntityImpl@7bd694a5</span></span><br><span class="line"><span class="comment"> * ==&gt;  Preparing: insert into ACT_ID_GROUP (ID_, REV_, NAME_, TYPE_) values ( ?, 1, ?, ? )</span></span><br><span class="line"><span class="comment"> * ==&gt; Parameters: leader(String),  组长(String), null</span></span><br><span class="line"><span class="comment"> * &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test08</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//添加用户组</span></span><br><span class="line">    <span class="type">GroupEntityImpl</span> <span class="variable">g</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">GroupEntityImpl</span>();</span><br><span class="line">    g.setName(<span class="string">&quot; 组长&quot;</span>);</span><br><span class="line">    g.setId(<span class="string">&quot;leader&quot;</span>);</span><br><span class="line">    <span class="comment">//和用户一样 组的信息也使用了乐观锁 所以记得加revision</span></span><br><span class="line">    g.setRevision(<span class="number">0</span>);</span><br><span class="line">    identityService.saveGroup(g);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="删-1"><a href="#删-1" class="headerlink" title="删"></a>删</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 ID删除一个group</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 对应SQL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  ==&gt;  Preparing: delete from ACT_ID_MEMBERSHIP where GROUP_ID_ = ?</span></span><br><span class="line"><span class="comment"> *  ==&gt; Parameters: leader(String)</span></span><br><span class="line"><span class="comment"> *  &lt;==    Updates: 0</span></span><br><span class="line"><span class="comment"> *  ==&gt;  Preparing: delete from ACT_ID_GROUP where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> *  ==&gt; Parameters: leader(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> *  &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  为什么有两个删除sql？</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  ACT_ID_MEMBERSHIP表保存的是 用户id和组id之间的关联关系。所以当删除一个用户组的时候，所以需要先删除组中的用户</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  第二个就是删除具体的用户组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test09</span><span class="params">()</span> &#123;</span><br><span class="line">   identityService.deleteGroup(<span class="string">&quot;leader&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="改-1"><a href="#改-1" class="headerlink" title="改"></a>改</h3><p>就是给用户组添加用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 给用户组添加用户</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 对应的sql语句</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * inserting: org.flowable.idm.engine.impl.persistence.entity.MembershipEntityImpl@5bba9949</span></span><br><span class="line"><span class="comment">    * ==&gt;  Preparing: insert into ACT_ID_MEMBERSHIP (USER_ID_, GROUP_ID_) values ( ?, ? )</span></span><br><span class="line"><span class="comment">    * ==&gt; Parameters: zhangsan(String), leader(String)</span></span><br><span class="line"><span class="comment">    * &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">Test10</span><span class="params">()</span> &#123;</span><br><span class="line">       String groupId=<span class="string">&quot;leader&quot;</span>;</span><br><span class="line">       String userId=<span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line">       <span class="comment">//添加用户和用户之间的关联关系</span></span><br><span class="line">       <span class="comment">//注意 表的底层使用了外键 所以这里需要确保传递的参数都是真实存在的</span></span><br><span class="line">       identityService.createMembership(userId,groupId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<br>

<p>修改用户组：将managers这个用户的name改成CEO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改用户组：将managers这个用户的name改成CEO</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * 跟之前user的更新一样，更新之前先查询，否则revision可能不对，会导致更新失败</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * sql语句：</span></span><br><span class="line"><span class="comment">    * ==&gt;  Preparing: update ACT_ID_GROUP SET REV_ = ?, NAME_ = ?, TYPE_ = ? where ID_ = ? and</span></span><br><span class="line"><span class="comment">    * ==&gt; Parameters: 2(Integer), CEO(String), null, managers(String), 1(Integer)</span></span><br><span class="line"><span class="comment">    * &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * 这个sql中 我们可以看出乐观锁的具体使用方式，先查出来一个Group，revision为1 然后更新的时候将revision设置为2 ，</span></span><br><span class="line"><span class="comment">    * 但是在更新条件中，revision还是使用1</span></span><br><span class="line"><span class="comment">    * 这样我们更新的时候 就可以确保我们更新之前 这条记录没有被人更新过（如果被人更新过，则这条记录的revision就变成2了，本次更新就会失败）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">Test11</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//注意：更新之前先查询，因为上了乐观锁</span></span><br><span class="line">       <span class="type">Group</span> <span class="variable">managers</span> <span class="operator">=</span> identityService.createGroupQuery().groupId(<span class="string">&quot;managers&quot;</span>).singleResult();</span><br><span class="line">       managers.setName(<span class="string">&quot;CEO&quot;</span>);</span><br><span class="line">       identityService.saveGroup(managers);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="查-1"><a href="#查-1" class="headerlink" title="查"></a>查</h3><p>查询用户组：根据用户组名称去查询，注意的是，用户组名称不唯一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询用户组：根据用户组名称去查询，注意的是，用户组名称不唯一</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 对应的SQL如下：</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * ==&gt;  Preparing: SELECT RES.* from ACT_ID_GROUP RES WHERE RES.NAME_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * ==&gt; Parameters: CEO(String)</span></span><br><span class="line"><span class="comment"> * &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test12</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Group&gt; ceo = identityService.createGroupQuery().groupName(<span class="string">&quot;CEO&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Group group : ceo) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, group.getId(), group.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>按照用户组的用户去查询  这个需要多表联合查询  下面案例  查询包含zhangsan这个用户的用户组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照用户组的用户去查询  这个需要多表联合查询  下面案例  查询包含zhangsan这个用户的用户组</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 对应SQL</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ==&gt; Preparing: SELECT RES.* from ACT_ID_GROUP RES WHERE exists(select 1 from ACT_ID_MEMBERSHIP M where M.GROUP_ID_ = RES.ID_ and M.USER_ID_ = ?) order by RES.ID_ asc</span></span><br><span class="line"><span class="comment">     * ==&gt; Parameters: zhangsan(String)</span></span><br><span class="line"><span class="comment">     * &lt;==       Total: 1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">Test13</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Group&gt; list = identityService.createGroupQuery().groupMember(<span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Group group : list) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, group.getId(), group.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<br>

<p>自定义查询SQL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义查询SQL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">Test14</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ==&gt;  Preparing: select * from ACT_ID_PROPERTY</span></span><br><span class="line"><span class="comment">         * ==&gt; Parameters:</span></span><br><span class="line"><span class="comment">         * &lt;==      Total: 1</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;Group&gt; list = identityService.createNativeGroupQuery().sql(<span class="string">&quot;SELECT RES.* from ACT_ID_GROUP RES WHERE exists(select 1 from ACT_ID_MEMBERSHIP M where M.GROUP_ID_ = RES.ID_ and M.USER_ID_ = #&#123;userId&#125;) order by RES.ID_ asc&quot;</span>).</span><br><span class="line">                parameter(<span class="string">&quot;userId&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Group group : list) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, group.getId(), group.getName());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<br>

<p>查询系统信息或表信息等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">Test15</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//查询系统信息 本质上是查询ACT_ID_PROPERTY</span></span><br><span class="line">        Map&lt;String, String&gt; properties = idmManagementService.getProperties();</span><br><span class="line">        Set&lt;String&gt; key = properties.keySet();</span><br><span class="line">        <span class="keyword">for</span> (String s : key) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;key:&#123;&#125;;value:&#123;&#125;&quot;</span>,s,properties.get(s));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询实体类对应的表名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> idmManagementService.getTableName(Group.class);</span><br><span class="line">        logger.info(<span class="string">&quot;tableName:&#123;&#125;&quot;</span>,tableName);</span><br><span class="line">        <span class="comment">//获取表的详细信息</span></span><br><span class="line">        <span class="type">TableMetaData</span> <span class="variable">tableMetaData</span> <span class="operator">=</span> idmManagementService.getTableMetaData(tableName);</span><br><span class="line">        logger.info(<span class="string">&quot;列名&#123;&#125;&quot;</span>,tableMetaData.getColumnNames());</span><br><span class="line">        logger.info(<span class="string">&quot;列的类型&#123;&#125;&quot;</span>,tableMetaData.getColumnTypes());</span><br><span class="line">        logger.info(<span class="string">&quot;表名&#123;&#125;&quot;</span>,tableMetaData.getColumnTypes());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><br><br><br></p>
<h1 id="流程定义与流程实例"><a href="#流程定义与流程实例" class="headerlink" title="流程定义与流程实例"></a>流程定义与流程实例</h1><ol>
<li>流程定义<br>在使用 flowable 的时候，我们首先需要画一个流程图，要在我们的代码中使用流程图，就必须先把流程图部署到项目中。加载到系统中的流程图，就是流程定义：ProcessDefinition。</li>
<li>流程实例<br>我们启动的每一个具体的流程，就是一个流程实例 ProcessInstance。<br>ProcessDefinition 相当于 Java 中的类，ProcessInstance 则相当于根据这个类创建出来的对象。</li>
</ol>
<p>在 Flowable 中，所有跟流程部署相关的表，都是以 ACT_RE_前缀开始的。</p>
<h2 id="流程定义-ProcessDefinition"><a href="#流程定义-ProcessDefinition" class="headerlink" title="流程定义 ProcessDefinition"></a>流程定义 ProcessDefinition</h2><h3 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h3><p>在 Spring Boot 中，凡是放在 resources&#x2F;processes 目录下的流程文件，默认情况下，都会被自动部署。</p>
<p>创建 Spring Boot 项目，添加 flowable 依赖，并配置 application.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">wqeq</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql:///flowable_process?serverTimezone=Asia/Shanghai&amp;useSSL=false&amp;nullCatalogMeansCurrent=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging.level.org.flowable</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>任意绘制一个流程图，放到 resources&#x2F;processes 目录下：</p>
<div style="text-align:center">
  <style>.fiysblmuklyw{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221011170439432.png" class="fiysblmuklyw" alt="image-20221011170439432">
</div>

<br>

<p>启动 Spring Boot 项目，启动之后，这个流程就被自动部署了。</p>
<p><code>ACT_RE_DEPLOYMENT</code>和 <code>ACT_RE_PROCDEF</code>分别保存了流程定义相关的信息。<code>ACT_GE_BYTEARRAY</code>表则保存了刚刚定义的流程的 XML 文件以及根据这个 XML 文件所自动生成的流程图。</p>
<p>三张表的关系：</p>
<ul>
<li><code>ACT_RE_DEPLOYMENT</code>和 <code>ACT_RE_PROCDEF</code>是一对一的关系。</li>
<li><code>ACT_RE_DEPLOYMENT</code>和<code>ACT_GE_BYTEARRAY</code>是一对多的关系，一个流程部署 ID 对应两条<code>ACT_GE_BYTEARRAY</code>表中的记录（默认）。</li>
</ul>
<p>流程 部署好之后，如果想要修改，可以直接修改，修改之后，流程会自动升级（数据库中的记录会自动更新）。</p>
<p>举个例子：</p>
<blockquote>
<p>假设我们现在修改了流程定义的名字，然后重新启动 Spring Boot 项目，那么 <code>ACT_RE_DEPLOYMENT</code> 表中会增加一条部署记录，同时 <code>ACT_RE_PROCDEF</code> 表也会增加一条新的流程定义信息，新的流程信息中，该变的字段会自动变，同时版本号 <code>VERSION_</code>会自增 1。<code>ACT_GE_BYTEARRAY</code> 表中也会新增两条记录，和最新的版本号的定义相对应。</p>
</blockquote>
<p><strong>注意：流程图的更新，主要是以流程定义的 id 为依据，如果流程定义的内容发生变化，但是流程 id 没有变，则流程定义升级；如果流程图定义的 id 发生变化，则直接重新部署新的流程。</strong></p>
<br>

<p>在流程的定义中，XML 文件中的 <code>targetNamespace</code>属性，其实就是流程的分类定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:flowable</span>=<span class="string">&quot;http://flowable.org/bpmn&quot;</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">&quot;http://www.omg.org/spec/BPMN/20100524/DI&quot;</span> <span class="attr">xmlns:omgdc</span>=<span class="string">&quot;http://www.omg.org/spec/DD/20100524/DC&quot;</span> <span class="attr">xmlns:omgdi</span>=<span class="string">&quot;http://www.omg.org/spec/DD/20100524/DI&quot;</span> <span class="attr">typeLanguage</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">expressionLanguage</span>=<span class="string">&quot;http://www.w3.org/1999/XPath&quot;</span> <span class="attr">targetNamespace</span>=<span class="string">&quot;http://www.flowable.org/processdef&quot;</span> <span class="attr">exporter</span>=<span class="string">&quot;Flowable Open Source Modeler&quot;</span> <span class="attr">exporterVersion</span>=<span class="string">&quot;6.7.2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;javaboy_submit_an_expense_account2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;javaboy的报销流程2&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>javaboy的报销流程<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-71C33AD7-E892-4037-AFBB-464957E41378&quot;</span> <span class="attr">name</span>=<span class="string">&quot;填写报销材料&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;$INITIATOR&quot;</span> <span class="attr">flowable:formKey</span>=<span class="string">&quot;submit_an_expense_account&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:activiti-idm-initiator</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[true]]&gt;<span class="tag">&lt;/<span class="name">modeler:activiti-idm-initiator</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果想要修改流程定义的分类，直接修改该属性即可。</p>
<p>Spring Boot 中，关于流程定义的几个重要属性：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否在项目启动的时候，自动去检查流程定义目录下是否有对应的流程定义文件，如果这个属性为 true（默认既此），就表示去检查，否则不检查（意味着不会自动部署流程）</span></span><br><span class="line"><span class="attr">flowable.check-process-definitions</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 设置流程定义文件的位置，默认位置就是 classpath*:/processes/</span></span><br><span class="line"><span class="attr">flowable.process-definition-location-prefix</span>=<span class="string">classpath*:/javaboy/</span></span><br><span class="line"><span class="comment"># 这个是指定流程定义 XML 文件的后缀，默认后缀有两个：**.bpmn20.xml,**.bpmn</span></span><br><span class="line"><span class="attr">flowable.process-definition-location-suffixes</span>=<span class="string">**.bpmn20.xml,**.bpmn</span></span><br></pre></td></tr></table></figure>



<h3 id="手动部署"><a href="#手动部署" class="headerlink" title="手动部署"></a>手动部署</h3><h4 id="手动部署-1"><a href="#手动部署-1" class="headerlink" title="手动部署"></a>手动部署</h4><p>项目启动成功之后，再去部署流程。</p>
<p>首先，定义一个返回实体类model</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">省略有参构造 无参构造函数 和getset方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RespBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">ok</span><span class="params">(String msg,Object data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(<span class="number">200</span>,msg,data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">ok</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(<span class="number">200</span>,msg,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">error</span><span class="params">(String msg,Object data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(<span class="number">500</span>,msg,data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">error</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(<span class="number">500</span>,msg,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>手动部署流程接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个是我自定义的流程部署接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessDeployController</span> &#123;</span><br><span class="line">    <span class="comment">//RepositoryService 这个实体类可以用来操作 ACT_RE_XXX 这种表</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个就是我的流程部署接口，流程部署将来要上传一个文件，这个文件就是流程的 XML 文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/deploy&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RespBean <span class="title function_">deploy</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">DeploymentBuilder</span> <span class="variable">deploymentBuilder</span> <span class="operator">=</span> repositoryService</span><br><span class="line">                <span class="comment">//开始流程部署的构建</span></span><br><span class="line">                .createDeployment()</span><br><span class="line">                .name(<span class="string">&quot;JAVABOY的工作流&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 NAME_ 属性</span></span><br><span class="line">                .category(<span class="string">&quot;我的流程分类&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 CATEGORY_ 属性</span></span><br><span class="line">                .key(<span class="string">&quot;我的自定义的工作流的 KEY&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 KEY_ 属性</span></span><br><span class="line">                <span class="comment">//也可以用这个方法代替 addInputStream，但是注意，这个需要我们自己先去解析 IO 流程，将 XML 文件解析为一个字符串，然后就可以调用这个方法进行部署了</span></span><br><span class="line"><span class="comment">//                .addString()</span></span><br><span class="line">                <span class="comment">//设置文件的输入流程，将来通过这个输入流自动去读取 XML 文件</span></span><br><span class="line">                .addInputStream(file.getOriginalFilename(), file.getInputStream());</span><br><span class="line">        <span class="comment">//完成项目的部署</span></span><br><span class="line">        <span class="type">Deployment</span> <span class="variable">deployment</span> <span class="operator">=</span> deploymentBuilder.deploy();</span><br><span class="line">        <span class="keyword">return</span> RespBean.ok(<span class="string">&quot;部署成功&quot;</span>, deployment.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/deploy2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RespBean <span class="title function_">deploy2</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> file.getInputStream();</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        is.close();</span><br><span class="line">        <span class="type">DeploymentBuilder</span> <span class="variable">deploymentBuilder</span> <span class="operator">=</span> repositoryService</span><br><span class="line">                <span class="comment">//开始流程部署的构建</span></span><br><span class="line">                .createDeployment()</span><br><span class="line">                .name(<span class="string">&quot;JAVABOY的工作流&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 NAME_ 属性</span></span><br><span class="line">                .category(<span class="string">&quot;我的流程分类&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 CATEGORY_ 属性</span></span><br><span class="line">                .key(<span class="string">&quot;我的自定义的工作流的 KEY&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 KEY_ 属性</span></span><br><span class="line">                <span class="comment">//也可以用这个方法代替 addInputStream，但是注意，这个需要我们自己先去解析 IO 流程，将 XML 文件解析为一个字符串，然后就可以调用这个方法进行部署了</span></span><br><span class="line"><span class="comment">//                .addString()</span></span><br><span class="line">                <span class="comment">//设置文件的输入流程，将来通过这个输入流自动去读取 XML 文件</span></span><br><span class="line"><span class="comment">//                .addInputStream(file.getOriginalFilename(), file.getInputStream());</span></span><br><span class="line">                <span class="comment">//注意这里需要设置资源名称，这个资源名称不能随意取值，建议最好和文件名保持一致</span></span><br><span class="line">                .addBytes(file.getOriginalFilename(), baos.toByteArray());</span><br><span class="line">        <span class="comment">//完成项目的部署</span></span><br><span class="line">        <span class="type">Deployment</span> <span class="variable">deployment</span> <span class="operator">=</span> deploymentBuilder.deploy();</span><br><span class="line">        <span class="keyword">return</span> RespBean.ok(<span class="string">&quot;部署成功&quot;</span>, deployment.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h4 id="查询流程定义"><a href="#查询流程定义" class="headerlink" title="查询流程定义"></a>查询流程定义</h4><p>查询所有的流程定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActReTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ActReTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询流程定义</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 对应的 SQL 如下：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_PROCDEF RES order by RES.ID_ asc</span></span><br><span class="line"><span class="comment">     * : ==&gt; Parameters:</span></span><br><span class="line"><span class="comment">     * : &lt;==      Total: 2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//查询所有定义的流程</span></span><br><span class="line">        List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery().list();</span><br><span class="line">        <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,version:&#123;&#125;,category:&#123;&#125;&quot;</span>,pd.getId(),pd.getName(),pd.getVersion(),pd.getCategory());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>查询所有流程的最新版本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有流程的最新版本</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 对应的 SQL：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_PROCDEF RES WHERE RES.VERSION_ = (select max(VERSION_) from ACT_RE_PROCDEF where KEY_ = RES.KEY_ and ( (TENANT_ID_ IS NOT NULL and TENANT_ID_ = RES.TENANT_ID_) or (TENANT_ID_ IS NULL and RES.TENANT_ID_ IS NULL) ) ) order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: </span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery()</span><br><span class="line">            <span class="comment">//设置查询流程定义的最新版本</span></span><br><span class="line">            .latestVersion()</span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,version:&#123;&#125;,category:&#123;&#125;&quot;</span>,pd.getId(),pd.getName(),pd.getVersion(),pd.getCategory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<br>

<p>根据流程定义的 key 去查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程定义的 key 去查询</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_PROCDEF RES WHERE RES.KEY_ = ? order by RES.VERSION_ desc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: javaboy_submit_an_expense_account(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 2</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery()</span><br><span class="line">            <span class="comment">//根据流程定义的 XML 文件中的 id 去查询一个流程，注意，XML 文件中的 id 对应 ACT_RE_PROCDEF 表中的 KEY_</span></span><br><span class="line">            .processDefinitionKey(<span class="string">&quot;javaboy_submit_an_expense_account&quot;</span>)</span><br><span class="line">            <span class="comment">//按照版本号排序</span></span><br><span class="line">            .orderByProcessDefinitionVersion()</span><br><span class="line">            .desc()</span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,version:&#123;&#125;,category:&#123;&#125;&quot;</span>,pd.getId(),pd.getName(),pd.getVersion(),pd.getCategory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>自定义查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程定义的 key 去查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createNativeProcessDefinitionQuery()</span><br><span class="line">            .sql(<span class="string">&quot;SELECT RES.* from ACT_RE_PROCDEF RES WHERE RES.KEY_ = #&#123;key&#125; order by RES.VERSION_ desc&quot;</span>)</span><br><span class="line">            .parameter(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;javaboy_submit_an_expense_account&quot;</span>)</span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,version:&#123;&#125;,category:&#123;&#125;&quot;</span>,pd.getId(),pd.getName(),pd.getVersion(),pd.getCategory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询流程部署"><a href="#查询流程部署" class="headerlink" title="查询流程部署"></a>查询流程部署</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询流程部署信息，本质上就是查询 ACT_RE_DEPLOYMENT 表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_DEPLOYMENT RES order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: </span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Deployment&gt; list = repositoryService.createDeploymentQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Deployment d : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,category:&#123;&#125;,,name:&#123;&#125;,key:&#123;&#125;&quot;</span>,d.getId(),d.getCategory(),d.getName(),d.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>根据流程部署的分类名称去查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程部署的分类，去查询流程部署信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_DEPLOYMENT RES WHERE RES.CATEGORY_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 我的流程分类(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 2</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Deployment&gt; list = repositoryService.createDeploymentQuery()</span><br><span class="line">            <span class="comment">//根据流程部署的分类去查询</span></span><br><span class="line">            .deploymentCategory(<span class="string">&quot;我的流程分类&quot;</span>)</span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span> (Deployment d : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,category:&#123;&#125;,,name:&#123;&#125;,key:&#123;&#125;&quot;</span>,d.getId(),d.getCategory(),d.getName(),d.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>根据流程部署信息，查询流程定义信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程部署的 ID 去查询流程定义</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_DEPLOYMENT RES order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: </span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 2</span></span><br><span class="line"><span class="comment"> * : Flushing dbSqlSession</span></span><br><span class="line"><span class="comment"> * : flush summary: 0 insert, 0 update, 0 delete.</span></span><br><span class="line"><span class="comment"> * : now executing flush...</span></span><br><span class="line"><span class="comment"> * : --- DeploymentQueryImpl finished --------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * : --- starting ProcessDefinitionQueryImpl --------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * : Running command with propagation REQUIRED</span></span><br><span class="line"><span class="comment"> * : Operation class org.flowable.engine.impl.interceptor.CommandInvoker$1 added to agenda</span></span><br><span class="line"><span class="comment"> * : Executing operation class org.flowable.engine.impl.interceptor.CommandInvoker$1</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_PROCDEF RES WHERE RES.DEPLOYMENT_ID_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 9a5d421d-3c95-11ed-99f7-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> * : Flushing dbSqlSession</span></span><br><span class="line"><span class="comment"> * : flush summary: 0 insert, 0 update, 0 delete.</span></span><br><span class="line"><span class="comment"> * : now executing flush...</span></span><br><span class="line"><span class="comment"> * : --- ProcessDefinitionQueryImpl finished --------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * : id:9b09aec0-3c95-11ed-99f7-acde48001122,name:javaboy的报销流程,version:1,category:http://www.flowable.org/processdef</span></span><br><span class="line"><span class="comment"> * : --- starting ProcessDefinitionQueryImpl --------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * : Running command with propagation REQUIRED</span></span><br><span class="line"><span class="comment"> * : Operation class org.flowable.engine.impl.interceptor.CommandInvoker$1 added to agenda</span></span><br><span class="line"><span class="comment"> * : Executing operation class org.flowable.engine.impl.interceptor.CommandInvoker$1</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RE_PROCDEF RES WHERE RES.DEPLOYMENT_ID_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: a31bea4a-3c96-11ed-9ebe-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> * : Flushing dbSqlSession</span></span><br><span class="line"><span class="comment"> * : flush summary: 0 insert, 0 update, 0 delete.</span></span><br><span class="line"><span class="comment"> * : now executing flush...</span></span><br><span class="line"><span class="comment"> * : --- ProcessDefinitionQueryImpl finished --------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * : id:a3d7e74d-3c96-11ed-9ebe-acde48001122,name:javaboy的报销流程666,version:2,category:http://www.flowable.org/processdef</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test07</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Deployment&gt; list = repositoryService.createDeploymentQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Deployment d : list) &#123;</span><br><span class="line">        List&lt;ProcessDefinition&gt; list1 = repositoryService.createProcessDefinitionQuery().deploymentId(d.getId()).list();</span><br><span class="line">        <span class="keyword">for</span> (ProcessDefinition pd : list1) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,version:&#123;&#125;,category:&#123;&#125;&quot;</span>, pd.getId(), pd.getName(), pd.getVersion(), pd.getCategory());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>自定义流程部署查询 SQL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 也可以自定义流程部署的查询 SQL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test08</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Deployment&gt; list = repositoryService.createNativeDeploymentQuery()</span><br><span class="line">            .sql(<span class="string">&quot;SELECT RES.* from ACT_RE_DEPLOYMENT RES WHERE RES.CATEGORY_ = #&#123;category&#125; order by RES.ID_ asc&quot;</span>)</span><br><span class="line">            .parameter(<span class="string">&quot;category&quot;</span>,<span class="string">&quot;我的流程分类&quot;</span>)</span><br><span class="line">            .list();</span><br><span class="line">    <span class="keyword">for</span> (Deployment d : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,category:&#123;&#125;,,name:&#123;&#125;,key:&#123;&#125;&quot;</span>,d.getId(),d.getCategory(),d.getName(),d.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h4 id="流程定义删除"><a href="#流程定义删除" class="headerlink" title="流程定义删除"></a>流程定义删除</h4><p>这个删除操作，涉及到流程定义的表，都会被删除掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除一个流程部署</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test09</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Deployment&gt; list = repositoryService.createDeploymentQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Deployment deployment : list) &#123;</span><br><span class="line">        repositoryService.deleteDeployment(deployment.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h2 id="流程实例-Process-Instance"><a href="#流程实例-Process-Instance" class="headerlink" title="流程实例 Process Instance"></a>流程实例 Process Instance</h2><p>两个概念：</p>
<ol>
<li><p>流程实例：ProcessInstance：通过流程定义启动的一个流程，这个启动后的流程就是流程实例，这个表示一个流程从开始到结束的最大流程分支，<strong>在一个流程中，只存在一个流程实例（执行实例可能有多个）</strong>，前面说的流程定义相当于是 Java 类，这里的流程实例相当于是 Java 对象。</p>
</li>
<li><p>执行实例：Execution：简单来说，在一个流程中，开始节点和结束节点是流程实例，其余节点是执行实例。从类的继承关系来说，ProcessInstance 实际上是 Execution 的子类，所以，流程实例可以算是执行实例的一种特殊情况。</p>
</li>
<li><ol>
<li>如果一个流程图中，只有一条线，那么一般来说，流程实例和执行实例就不同。</li>
<li>如果一个流程图中，包含多条线，那么每一条线就是一个执行实例。</li>
</ol>
</li>
</ol>
<h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><p>启动流程方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActRuTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//跟流程运行相关的操作，都在这个 Bean 中，在 Spring Boot 中，该 Bean 已经配置好，可以直接使用</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ActRuTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//设置流程的发起人</span></span><br><span class="line">        Authentication.setAuthenticatedUserId(<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">        <span class="comment">//这个流程定义的 key 实际上就是流程 XML 文件中的流程 id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">processDefinitionKey</span> <span class="operator">=</span> <span class="string">&quot;leave&quot;</span>;</span><br><span class="line">        <span class="comment">//流程启动成功之后，可以获取到一个流程实例</span></span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(processDefinitionKey);</span><br><span class="line">        logger.info(<span class="string">&quot;definitionId:&#123;&#125;,id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getProcessDefinitionId(), pi.getId(), pi.getName());</span><br><span class="line">        <span class="comment">//也可以通过流程定义的 id 去启动一个流程，但是需要注意，流程定义的 id 需要自己去查询，这个 id 并不是 XML 文件中定义的流程 ID</span></span><br><span class="line"><span class="comment">//        String processDefinitionId = &quot;&quot;;</span></span><br><span class="line"><span class="comment">//        runtimeService.startProcessInstanceById(processDefinitionId);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>当一个流程启动成功后，我们首先去查看 <code>ACT_RU_EXECUTION</code>表，该表中保存了所有的流程执行实例信息，包括启动节点以及其他的任务节点信息都保存在这个表中。同时，如果这个节点，还是一个 UserTask，那么这个节点的信息还会保存在 <code>ACT_RU_TASK</code>表中（该表用来保存 UserTask）。</p>
<p>另外还有 <code>ACT_RU_ACTINST</code>表中，会保存流程活动的执行情况。</p>
<p>当然，无论哪张表，只要流程执行结束，<code>ACT_RU_</code>相关的表中的数据都会被删除。</p>
<p><strong>另外一种启动方式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActRuTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//跟流程运行相关的操作，都在这个 Bean 中，在 Spring Boot 中，该 Bean 已经配置好，可以直接使用</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ActRuTest.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    IdentityService identityService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 另外一种流程启动的例子和流程发起人设置的例子</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//设置流程的发起人</span></span><br><span class="line">        identityService.setAuthenticatedUserId(<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">        <span class="comment">//查询最新版本的 leave 流程的定义信息</span></span><br><span class="line">        <span class="type">ProcessDefinition</span> <span class="variable">pd</span> <span class="operator">=</span> repositoryService.createProcessDefinitionQuery().processDefinitionKey(<span class="string">&quot;leave&quot;</span>).latestVersion().singleResult();</span><br><span class="line">        <span class="comment">//也可以通过流程定义的 id 去启动一个流程，但是需要注意，流程定义的 id 需要自己去查询，这个 id 并不是 XML 文件中定义的流程 ID</span></span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceById(pd.getId());</span><br><span class="line">        logger.info(<span class="string">&quot;definitionId:&#123;&#125;,id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getProcessDefinitionId(), pi.getId(), pi.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<br>

<p>接下来，根据用户名去查询每一个用户需要处理的流程，并处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询 wangwu 需要执行的任务，并处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 查询 wangwu 需要处理的任务，对应的 SQL：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RU_TASK RES WHERE RES.ASSIGNEE_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: wangwu(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * wangwu 去处理任务：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 首先去 ACT_RU_TASK 表中添加一条记录，这个新的记录，就是主管审批。</span></span><br><span class="line"><span class="comment"> * 然后从 ACT_RU_TASK 表中删除掉之前的需要 wangwu 完成的记录。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 上面这两个操作是在同一个事务中完成的。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;javaboy&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,assignee:&#123;&#125;,name:&#123;&#125;&quot;</span>,task.getId(),task.getAssignee(),task.getName());</span><br><span class="line">        <span class="comment">//王五完成自己的任务</span></span><br><span class="line">        taskService.complete(task.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="查看流程是否结束"><a href="#查看流程是否结束" class="headerlink" title="查看流程是否结束"></a>查看流程是否结束</h3><p>查的是ACT_RU_EXECUTION表的PROC_INST_ID属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询一个流程是否执行结束</span></span><br><span class="line"><span class="comment"> * 如果 ACT_RU_EXECUTION 表中，由于关于这个流程的记录，说明这个流程还在执行中</span></span><br><span class="line"><span class="comment"> * 如果 ACT_RU_EXECUTION 表中，没有关于这个流程的记录，说明这个流程已经执行结束了</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意，虽然我们是去 ACT_RU_EXECUTION 表中查询，且该表中同一个流程实例 ID 对应了多条记录，但是大家注意，这里查询到的其实还是一个流程实例。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">processId</span> <span class="operator">=</span> <span class="string">&quot;cc189d50-3cac-11ed-8459-acde48001122&quot;</span>;</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.createProcessInstanceQuery().processInstanceId(processId).singleResult();</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="literal">null</span>) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;流程执行结束&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;流程正在执行中&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="查看运行的活动节点"><a href="#查看运行的活动节点" class="headerlink" title="查看运行的活动节点"></a>查看运行的活动节点</h3><p>就是当前这个流程，走到哪一步了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查看运行活动节点，本质上其实就是查看 ACT_RU_EXECUTION 表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; executions = runtimeService.createExecutionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : executions) &#123;</span><br><span class="line">        <span class="comment">//查询某一个执行实例的活动节点</span></span><br><span class="line">        List&lt;String&gt; activeActivityIds = runtimeService.getActiveActivityIds(execution.getId());</span><br><span class="line">        <span class="keyword">for</span> (String activeActivityId : activeActivityIds) &#123;</span><br><span class="line">            <span class="comment">//这里拿到的其实就是 ACT_RU_EXECUTION 表中的 ACT_ID_ 字段</span></span><br><span class="line">            logger.info(<span class="string">&quot;activeActivityId:&#123;&#125;&quot;</span>, activeActivityId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>

<h3 id="删除流程实例"><a href="#删除流程实例" class="headerlink" title="删除流程实例"></a>删除流程实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 删除一个正在执行的流程，注意这个只会删除正在执行的流程实例信息，并不会删除历史流程信息（历史信息被更新）。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_VARIABLE where EXECUTION_ID_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87df7272-3cad-11ed-9026-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_IDENTITYLINK where PROC_INST_ID_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87df7272-3cad-11ed-9026-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 2</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_TASK where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87e4c9a9-3cad-11ed-9026-acde48001122(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_TASK where EXECUTION_ID_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87df7272-3cad-11ed-9026-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 0</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_ACTINST where PROC_INST_ID_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87df7272-3cad-11ed-9026-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 3</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_ACTINST where PROC_INST_ID_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87df7272-3cad-11ed-9026-acde48001122(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 0</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_EXECUTION where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87e035c5-3cad-11ed-9026-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: delete from ACT_RU_EXECUTION where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 87df7272-3cad-11ed-9026-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">processInstanceId</span> <span class="operator">=</span> <span class="string">&quot;87df7272-3cad-11ed-9026-acde48001122&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">deleteReason</span> <span class="operator">=</span> <span class="string">&quot;想删除了&quot;</span>;</span><br><span class="line">    runtimeService.deleteProcessInstance(processInstanceId, deleteReason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><br><br></p>
<h2 id="流程的挂起和恢复"><a href="#流程的挂起和恢复" class="headerlink" title="流程的挂起和恢复"></a>流程的挂起和恢复</h2><ol>
<li>流程定义的挂起和恢复。</li>
<li>流程实例的挂起和恢复。</li>
</ol>
<h3 id="流程定义"><a href="#流程定义" class="headerlink" title="流程定义"></a>流程定义</h3><p>查看流程定义是否挂起：</p>
<p>act_re_procdef表中的SUSPENSION_STATE_字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查看一个已经定义好的流程，是否是一个挂起状态</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 挂起的流程定义，是无法开启一个流程实例的</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test10</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//查询所有的流程定义</span></span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        <span class="comment">//根据流程定义的 id 判断一个流程定义是否挂起</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">processDefinitionSuspended</span> <span class="operator">=</span> repositoryService.isProcessDefinitionSuspended(pd.getId());</span><br><span class="line">        <span class="keyword">if</span> (processDefinitionSuspended) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;流程定义 &#123;&#125; 已经挂起&quot;</span>, pd.getId());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;流程定义 &#123;&#125; 没有挂起&quot;</span>, pd.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>挂起一个流程定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 挂起一个流程定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 挂起的流程定义，是无法启动一个流程实例的</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 执行的 SQL 如下：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> : ==&gt;  Preparing: update ACT_RE_PROCDEF SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> : ==&gt; Parameters: 2(Integer), 2(Integer), leave:1:48375905-43e2-11ed-ba47-acde48001122(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> 所以，挂起一个流程定义，本质上，其实就是修改 ACT_RE_PROCDEF 表中，对应的记录的 SUSPENSION_STATE_ 字段的状态值为 2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test11</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        <span class="comment">//根据流程定义的 id 挂起一个流程定义</span></span><br><span class="line">        repositoryService.suspendProcessDefinitionById(pd.getId());</span><br><span class="line">        logger.info(<span class="string">&quot;&#123;&#125; 流程定义已经挂起&quot;</span>,pd.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>对于一个已经挂起的流程定义，是无法据此启动一个流程实例的，强行启动，会抛出如下错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.flowable.common.engine.api.FlowableException: Cannot start process instance. Process definition javaboy的请假流程图<span class="number">666</span> (id = leave:<span class="number">1</span>:f1f2c354-4ed6-11ed-a142-6e6a7761cc27) is suspended</span><br></pre></td></tr></table></figure>

<br>

<p>激活一个已经挂起的流程定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 激活一个已经挂起的流程定义</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: update ACT_RE_PROCDEF SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 3(Integer), 1(Integer), leave:1:48375905-43e2-11ed-ba47-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 激活一个流程定义，本质上，其实就是将 ACT_RE_PROCDEF 表中相应记录的 SUSPENSION_STATE_ 字段的值改为 1</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test12</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        repositoryService.activateProcessDefinitionById(pd.getId());</span><br><span class="line">        logger.info(<span class="string">&quot;&#123;&#125; 流程定义已经被激活&quot;</span>, pd.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="流程实例"><a href="#流程实例" class="headerlink" title="流程实例"></a>流程实例</h3><p>挂起一个流程实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 挂起一个流程实例</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 对于一个挂起的流程实例，我们是无法执行相应的 Task 的</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流程实例的挂起，最终也会挂起流程定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 一个被挂起的流程实例：</span></span><br><span class="line"><span class="comment"> * 1。 流程实例本身被挂起</span></span><br><span class="line"><span class="comment"> * 2。 流程的 Task 被挂起。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: update ACT_RU_EXECUTION SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 2(Integer), 2(Integer), dd7000f0-43e5-11ed-bbdc-acde48001122(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * : updating: Execution[ id &#x27;dd709d33-43e5-11ed-bbdc-acde48001122&#x27; ] - activity &#x27;sid-2F900F54-E047-40AC-A09C-71181386A6C1&#x27; - parent &#x27;dd7000f0-43e5-11ed-bbdc-acde4800112</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: update ACT_RU_EXECUTION SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 2(Integer), 2(Integer), dd709d33-43e5-11ed-bbdc-acde48001122(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * : updating: Task[id=dd746dc7-43e5-11ed-bbdc-acde48001122, name=提交请假申请]</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: update ACT_RU_TASK SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_= ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 2(Integer), 2(Integer), dd746dc7-43e5-11ed-bbdc-acde48001122(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * : updating: ProcessDefinitionEntity[leave:1:cc46d851-43e5-11ed-bdc3-acde48001122]</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: update ACT_RE_PROCDEF SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 2(Integer), 2(Integer), leave:1:cc46d851-43e5-11ed-bdc3-acde48001122(String), 1(Integer)</span></span><br><span class="line"><span class="comment"> * : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 流程实例的挂起，一共涉及到三张表，分别是 ACT_RU_EXECUTION（流程实例被挂起）、ACT_RU_TASK（流程的 Task 被挂起） 以及 ACT_RE_PROCDEF（流程定义被挂起）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test07</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//查询所有的流程定义</span></span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        <span class="comment">//1. 流程定义的 ID</span></span><br><span class="line">        <span class="comment">//2. 是否挂起这个流程定义所对应的流程实例</span></span><br><span class="line">        <span class="comment">//3。这是挂起的时间，null 表示立即挂起，也可以给一个具体的时间，表示到期之后才会被挂起。</span></span><br><span class="line">        repositoryService.suspendProcessDefinitionById(pd.getId(), <span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>对于一个挂起的流程实例，是无法执行其 Task 的，如果强行执行，报错信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.flowable.common.engine.api.FlowableException: Cannot complete a suspended task</span><br></pre></td></tr></table></figure>

<p>激活一个已经挂起的流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 激活一个挂起的流程实例</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 激活就是挂起的一个反向操作：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 激活，也会涉及到三张表，分别是：ACT_RU_EXECUTION、ACT_RU_TASK 以及 ACT_RE_PROCDEF</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 挂起是将这三张表中的 SUSPENSION_STATE_ 字段，由 1 改为 2</span></span><br><span class="line"><span class="comment"> * 激活就是将这三张表中的 SUSPENSION_STATE_ 由 2 改为 1</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> : ==&gt;  Preparing: update ACT_RE_PROCDEF SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> : ==&gt; Parameters: 3(Integer), 1(Integer), leave:1:cc46d851-43e5-11ed-bdc3-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> : updating: ProcessInstance[dd7000f0-43e5-11ed-bbdc-acde48001122]</span></span><br><span class="line"><span class="comment"> : ==&gt;  Preparing: update ACT_RU_EXECUTION SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> : ==&gt; Parameters: 3(Integer), 1(Integer), dd7000f0-43e5-11ed-bbdc-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> : updating: Execution[ id &#x27;dd709d33-43e5-11ed-bbdc-acde48001122&#x27; ] - activity &#x27;sid-2F900F54-E047-40AC-A09C-71181386A6C1&#x27; - parent &#x27;dd7000f0-43e5-11ed-bbdc-acde48001122&#x27;</span></span><br><span class="line"><span class="comment"> : ==&gt;  Preparing: update ACT_RU_EXECUTION SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_ = ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> : ==&gt; Parameters: 3(Integer), 1(Integer), dd709d33-43e5-11ed-bbdc-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> : updating: Task[id=dd746dc7-43e5-11ed-bbdc-acde48001122, name=提交请假申请]</span></span><br><span class="line"><span class="comment"> : ==&gt;  Preparing: update ACT_RU_TASK SET REV_ = ?, SUSPENSION_STATE_ = ? where ID_= ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> : ==&gt; Parameters: 3(Integer), 1(Integer), dd746dc7-43e5-11ed-bbdc-acde48001122(String), 2(Integer)</span></span><br><span class="line"><span class="comment"> : &lt;==    Updates: 1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test08</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;ProcessDefinition&gt; list = repositoryService.createProcessDefinitionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (ProcessDefinition pd : list) &#123;</span><br><span class="line">        repositoryService.activateProcessDefinitionById(pd.getId(), <span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="DataObject"><a href="#DataObject" class="headerlink" title="DataObject"></a>DataObject</h2><p>这个用来设置流程的一些全局的属性。</p>
<p>这个东西，本质上就是给流程设置一些全局属性。我们可以在绘制流程图的时候进行设置，设置时候，记得不要选择任何流程节点。</p>
<div style="text-align:center">
  <style>.eypfonsrptqv{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1664894368961-a9686cd7-3cb0-4b6b-966a-0bff3e317330.png" class="eypfonsrptqv" alt="img">
</div>

<div style="text-align:center">
  <style>.xlyduwmcircu{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1664894611222-a7cdc678-bb08-4be2-a7a3-896e6aadb54b.png" class="xlyduwmcircu" alt="img">
</div>

<p>生成的 XML 文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;leave&quot;</span> <span class="attr">name</span>=<span class="string">&quot;javaboy的请假流程图&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>javaboy的请假流程图<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dataObject</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span> <span class="attr">name</span>=<span class="string">&quot;流程定义的名称&quot;</span> <span class="attr">itemSubjectRef</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flowable:value</span>&gt;</span>javaboy的请假流程<span class="tag">&lt;/<span class="name">flowable:value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dataObject</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dataObject</span> <span class="attr">id</span>=<span class="string">&quot;date&quot;</span> <span class="attr">name</span>=<span class="string">&quot;流程绘制时间&quot;</span> <span class="attr">itemSubjectRef</span>=<span class="string">&quot;xsd:datetime&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flowable:value</span>&gt;</span>2022-10-10T00:00:00<span class="tag">&lt;/<span class="name">flowable:value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dataObject</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dataObject</span> <span class="attr">id</span>=<span class="string">&quot;site&quot;</span> <span class="attr">name</span>=<span class="string">&quot;流程作者网站&quot;</span> <span class="attr">itemSubjectRef</span>=<span class="string">&quot;xsd:string&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flowable:value</span>&gt;</span>www.javaboy.org<span class="tag">&lt;/<span class="name">flowable:value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dataObject</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:initiator</span>=<span class="string">&quot;INITIATOR&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-2F900F54-E047-40AC-A09C-71181386A6C1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;提交请假申请&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;$INITIATOR&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">modeler:activiti-idm-initiator</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[true]]&gt;<span class="tag">&lt;/<span class="name">modeler:activiti-idm-initiator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-5173B338-945D-4266-8FF6-1CEAA4BC9BDF&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-2F900F54-E047-40AC-A09C-71181386A6C1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-745B2D5D-599B-42E6-98F4-78833C81B6E9&quot;</span> <span class="attr">name</span>=<span class="string">&quot;主管审批&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;zhangsan&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-09948146-3573-4F5C-875B-2ECF03BBAB9B&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-2F900F54-E047-40AC-A09C-71181386A6C1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-745B2D5D-599B-42E6-98F4-78833C81B6E9&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-9462F815-6A53-4E32-879F-5E030C003790&quot;</span> <span class="attr">name</span>=<span class="string">&quot;经理审批&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;javaboy&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-9BA1715D-77DD-4B9A-A9DB-549A0284BDAF&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-745B2D5D-599B-42E6-98F4-78833C81B6E9&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-9462F815-6A53-4E32-879F-5E030C003790&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-B8B67E20-8935-4645-9959-A1B51795AFAC&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-9058115E-EB5B-4238-ADB6-A89B8979A31E&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-9462F815-6A53-4E32-879F-5E030C003790&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-B8B67E20-8935-4645-9959-A1B51795AFAC&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>dataObject 这个节点是属于 process 的，而不是属于某一个具体的节点，因此，这里的 dataObject 可以理解为一个全局的属性。</p>
<blockquote>
<p>由于默认识别的流程图的 XML 文件，后缀是 <code>bpmn20.xml</code> 或者是 <code>bpmn</code>，所以，如果我们重复下载的流程文件名，可能会不满足要求，这里注意，需要自行修改一下。</p>
</blockquote>
<p>当流程启动成功之后，dataObject 中的数据，实际上是保存在 <code>ACT_RU_VARIABLE</code>表中的。</p>
<div style="text-align:center">
  <style>.pjdasaqhklgz{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1664896120449-4cf24984-cd42-414b-8249-b3ea771bcdcf.png" class="pjdasaqhklgz" alt="img">
</div>

<p>我们一开始设置的流程启动人的数据，也是记录在这个表中的。</p>
<p>查询流程的 dataObject 数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询一个流程的所有 DataObject 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test10</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; list = runtimeService.createExecutionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : list) &#123;</span><br><span class="line">        Map&lt;String, DataObject&gt; dataObjects = runtimeService.getDataObjects(execution.getId());</span><br><span class="line">        Set&lt;String&gt; keySet = dataObjects.keySet();</span><br><span class="line">        <span class="keyword">for</span> (String key : keySet) &#123;</span><br><span class="line">            <span class="type">DataObject</span> <span class="variable">data</span> <span class="operator">=</span> dataObjects.get(key);</span><br><span class="line">            logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,value:&#123;&#125;,type:&#123;&#125;&quot;</span>,data.getId(),data.getName(),data.getValue(),data.getType());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 流程执行实例，在一个流程中，查询 DataObject 的数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: select * from ACT_RU_VARIABLE WHERE EXECUTION_ID_ = ? AND TASK_ID_ is null AND NAME_ = ?</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: 0e557214-43f6-11ed-a596-acde48001122(String), 流程作者网站(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 查询某一个具体的 dataObject 对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test09</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DataObject</span> <span class="variable">data</span> <span class="operator">=</span> runtimeService.getDataObject(<span class="string">&quot;0e557214-43f6-11ed-a596-acde48001122&quot;</span>, <span class="string">&quot;流程作者网站&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;,value:&#123;&#125;,type:&#123;&#125;&quot;</span>,data.getId(),data.getName(),data.getValue(),data.getType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，当一个流程执行完毕后，<code>ACT_RU_VARIABLE</code> 表中，dataObject 的数据会被清除掉。</p>
<p><br><br></p>
<h2 id="Flowable-中的租户"><a href="#Flowable-中的租户" class="headerlink" title="Flowable 中的租户"></a>Flowable 中的租户</h2><ul>
<li>tenant</li>
</ul>
<p>假如我们有 A、B、C、D 四个子系统，现在四个子系统都需要部署一个名为 leave 的流程，那么如何区分这个流程呢？通过租户 Tenant 可以解决。</p>
<blockquote>
<p>如果我们在部署一个流程定义的时候，使用到了租户 ID，那么流程启动的时候，也必须指定租户 ID。</p>
</blockquote>
<p>当我们部署一个流程定义的时候，可以通过如下方式指定这个流程的租户 ID：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个就是我的流程部署接口，流程部署将来要上传一个文件，这个文件就是流程的 XML 文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tenantId 这个是租户 id，用来区分这个流程是属于哪一个租户的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/deploy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RespBean <span class="title function_">deploy</span><span class="params">(MultipartFile file,String tenantId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">DeploymentBuilder</span> <span class="variable">deploymentBuilder</span> <span class="operator">=</span> repositoryService</span><br><span class="line">            <span class="comment">//开始流程部署的构建</span></span><br><span class="line">            .createDeployment()</span><br><span class="line">            .name(<span class="string">&quot;JAVABOY的工作流&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 NAME_ 属性</span></span><br><span class="line">            .category(<span class="string">&quot;我的流程分类&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 CATEGORY_ 属性</span></span><br><span class="line">            .key(<span class="string">&quot;我的自定义的工作流的 KEY&quot;</span>)<span class="comment">//ACT_RE_DEPLOYMENT 表中的 KEY_ 属性</span></span><br><span class="line">            .tenantId(tenantId)</span><br><span class="line">            <span class="comment">//也可以用这个方法代替 addInputStream，但是注意，这个需要我们自己先去解析 IO 流程，将 XML 文件解析为一个字符串，然后就可以调用这个方法进行部署了</span></span><br><span class="line">              .addString()</span><br><span class="line">            <span class="comment">//设置文件的输入流程，将来通过这个输入流自动去读取 XML 文件</span></span><br><span class="line">            .addInputStream(file.getOriginalFilename(), file.getInputStream());</span><br><span class="line">    <span class="comment">//完成项目的部署</span></span><br><span class="line">    <span class="type">Deployment</span> <span class="variable">deployment</span> <span class="operator">=</span> deploymentBuilder.deploy();</span><br><span class="line">    <span class="keyword">return</span> RespBean.ok(<span class="string">&quot;部署成功&quot;</span>, deployment.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署成功之后，在 ACT_RE_PROCDEF 表中，可以看到 TENANT_ID_ 字段的具体值：</p>
<div style="text-align:center">
  <style>.owvfppmdelqk{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1664974208881-0e98ba76-7270-428e-961c-e14a15dd2582.png" class="owvfppmdelqk" alt="img">
</div>

<br>

<p>一个流程在定义的时候，如果指定了租户 ID，那么启动的时候，也必须指定租户 ID。</p>
<p>如果在启动流程的时候，没有指定租户 ID，强行启动，会抛出如下错误：</p>
<div style="text-align:center">
  <style>.lnzswprupgsi{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1664974332058-266789a7-67bc-4270-a475-cd5adb7f52ba.png" class="lnzswprupgsi" alt="img">
</div>

<p>启动一个带租户 ID 的流程，应该按照如下方式来启动；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动参数中，携带租户 ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test11</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//设置流程的发起人</span></span><br><span class="line">    Authentication.setAuthenticatedUserId(<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">    <span class="comment">//这个流程定义的 key 实际上就是流程 XML 文件中的流程 id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">processDefinitionKey</span> <span class="operator">=</span> <span class="string">&quot;leave&quot;</span>;</span><br><span class="line">    <span class="comment">//流程启动成功之后，可以获取到一个流程实例</span></span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKeyAndTenantId(processDefinitionKey,<span class="string">&quot;javaboy&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;definitionId:&#123;&#125;,id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getProcessDefinitionId(), pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>对于带有租户 ID 的流程，在执行具体的 Task 的时候，是不需要指定租户 ID 的。</p>
<p>但是在 <code>ACT_RU_TASK</code>表中，存在 <code>TENANT_ID_</code>字段，这个字段表示这个 Task 所属的租户。所以，虽然我们执行 Task 不需要租户 ID，但是，我们可以利用租户 ID 去查询一个 Task。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据租户 ID 查询一个 Task</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * : ==&gt;  Preparing: SELECT RES.* from ACT_RU_TASK RES WHERE RES.TENANT_ID_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * : ==&gt; Parameters: javaboy(String)</span></span><br><span class="line"><span class="comment"> * : &lt;==      Total: 1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test12</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; list = taskService.createTaskQuery().taskTenantId(<span class="string">&quot;javaboy&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;name:&#123;&#125;,assignee:&#123;&#125;&quot;</span>,task.getName(),task.getAssignee());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h1 id="流程任务"><a href="#流程任务" class="headerlink" title="流程任务"></a>流程任务</h1><p> ReceiveTask</p>
<p>这个就是一个接收任务，任务到达这个节点之后，一般来说，不需要额外做什么事情，但是需要用户手动 trigger 一下。</p>
<p>如果一个需要等待的任务，可以自动判断各种条件是否成熟，则可以通过并行网关去处理，但是如果无法自动判断，则需要通过 ReceiveTask 去处理，所以 ReceiveTask 就是让流程停在某一个节点上，然后人工判断一下流程是否继续往下走。</p>
<div style="text-align:center">
  <style>.hnmdjipqhugm{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665905314464-2ea34644-52ed-45cd-937c-0bde38497dfa.png" class="hnmdjipqhugm" alt="img">
</div>

<p>这种带信封图标的任务，就是一个 ReceiveTask，不同于 UserTask，这种 ReceiveTask 是不需要设置处理人的。</p>
<p>绘制好流程图之后，部署并启动。</p>
<p>启动代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKeyAndTenantId(<span class="string">&quot;ReceiveTaskDemo&quot;</span>, <span class="string">&quot;javaboy&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动成功之后，流程就会停在 统计今日销售额 这个节点上，然后执行如下代码，流程进入到下一个节点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; list = runtimeService.createExecutionQuery().activityId(<span class="string">&quot;统计今日销售额节点 ID&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : list) &#123;</span><br><span class="line">        <span class="comment">//触发一个 ReceiveTask 继续向下执行，但是这里需要的参数是一个</span></span><br><span class="line">        runtimeService.trigger(execution.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ps</strong>: 统计今日销售额节点 ID要在导出的xml文件里面copy</p>
<div style="text-align:center">
  <style>.zmqdoiuyhlxv{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221023112926052.png" class="zmqdoiuyhlxv" alt="image-20221023112926052">
</div>

<p>再继续，执行最后一个节点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; list = runtimeService.createExecutionQuery().activityId(<span class="string">&quot;发送报告给老板的节点 ID&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : list) &#123;</span><br><span class="line">        <span class="comment">//触发一个 ReceiveTask 继续向下执行，但是这里需要的参数是一个</span></span><br><span class="line">        runtimeService.trigger(execution.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**注意，**ReceiveTask 是不进 <code>ACT_RU_TASK</code> 表的，它默认被记录在 <code>ACT_RU_EXECUTION</code>表和 <code>ACT_RU_ACTINST</code>表中。</p>
<h2 id="UserTask"><a href="#UserTask" class="headerlink" title="UserTask"></a>UserTask</h2><p>这个就是用户任务，是 Flowable 中使用最多的一种任务类型，流程走到这个节点的时候，需要用户手动处理，然后才会继续向下走。</p>
<h3 id="设置单个用户"><a href="#设置单个用户" class="headerlink" title="设置单个用户"></a>设置单个用户</h3><p>这种 UserTask，指定它的处理人，有四种不同的方式。</p>
<h4 id="直接指定具体用户"><a href="#直接指定具体用户" class="headerlink" title="直接指定具体用户"></a>直接指定具体用户</h4><div style="text-align:center">
  <style>.oeccglpfqiry{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665906962035-ee90f0b1-a6d3-49d9-a6f5-f46dd503032c.png" class="oeccglpfqiry" alt="image.png">
</div>

<p>然后启动流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程启动成功之后，就自动进入到用户审批这个节点了，需要用户处理的 UserTask 都保存在 <code>ACT_RU_TASK</code>表中。</p>
<div style="text-align:center">
  <style>.zmzdvumzqcbl{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665907377359-ec50ec86-913e-4cc9-8f34-7b3b7d065cc5.png" class="zmzdvumzqcbl" alt="img">
</div>

<p>接下来，查询某一个用户需要处理的 Task：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询某一个用户需要处理的任务</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 这个查询对应的 SQL：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SELECT RES.* from ACT_RU_TASK RES WHERE RES.ASSIGNEE_ = ? order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;javaboy&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;name:&#123;&#125;,assignee:&#123;&#125;&quot;</span>, task.getName(), task.getAssignee());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询到用户需要处理的任务之后，有两种不同的处理思路：</p>
<ol>
<li>委派给其他人处理</li>
<li>直接自己处理了</li>
</ol>
<h5 id="委派给其他人"><a href="#委派给其他人" class="headerlink" title="委派给其他人"></a>委派给其他人</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 javaboy 需要处理的任务委派给 zhangsan 去处理</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 具体的 SQL 如下：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * update ACT_RU_TASK SET REV_ = ?, ASSIGNEE_ = ? where ID_= ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;javaboy&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">        <span class="comment">//为某一个 Task 设置处理人</span></span><br><span class="line">        taskService.setAssignee(task.getId(), <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个委派，本质上就是修改了 <code>ACT_RU_TASK</code>表中相应的 Task 的记录的 <code>ASSIGNEE_</code>的值。</p>
<h5 id="直接自己处理了"><a href="#直接自己处理了" class="headerlink" title="直接自己处理了"></a>直接自己处理了</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自己来处理任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">        <span class="comment">//查询到 zhangsan 的任务，并自己处理</span></span><br><span class="line">        taskService.complete(task.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h4 id="通过变量来设置"><a href="#通过变量来设置" class="headerlink" title="通过变量来设置"></a>通过变量来设置</h4><div style="text-align:center">
  <style>.fcspewqnjjdt{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665908544806-496c4162-0379-4dd5-b9d1-f0d81f9a9698.png" class="fcspewqnjjdt" alt="img">
</div>

<p>设置任务的处理人的时候，使用变量，${xxx} 就是一个变量引用。</p>
<p>对应的 XML 内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">name</span>=<span class="string">&quot;用户审批&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;$&#123;manager&#125;&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动流程，启动的时候顺便指定任务的处理人：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动一个流程，在启动的时候，指定任务的处理人</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    vars.put(<span class="string">&quot;manager&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    <span class="comment">//在流程启动的时候，通过变量去指定任务的处理人</span></span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>, vars);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动成功之后，在 <code>ACT_RU_TASK</code>表中，可以看到任务的处理人已经是 lisi 了。</p>
<div style="text-align:center">
  <style>.hnyirlkmidha{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665908826405-aa62feea-4b22-4e20-89d5-bfc99d0c1145.png" class="hnyirlkmidha" alt="img">
</div>

<br>

<h4 id="通过监听器来设置"><a href="#通过监听器来设置" class="headerlink" title="通过监听器来设置"></a>通过监听器来设置</h4><p>利用监听器，我们可以在一个任务创建的时候，为这个任务设置一个处理人。</p>
<div style="text-align:center">
  <style>.zkwshdrdyatp{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665909178130-900a5a18-9a73-4e4d-ae6b-5c8b695c849f.png" class="zkwshdrdyatp" alt="img">
</div>

<div style="text-align:center">
  <style>.mpxsycxuvddx{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665909193656-58eaca99-929d-477b-b784-ddc2a818a7bf.png" class="mpxsycxuvddx" alt="img">
</div>

<p>此时对应的 UserTask 节点内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">name</span>=<span class="string">&quot;用户审批&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flowable:taskListener</span> <span class="attr">event</span>=<span class="string">&quot;create&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.javaboy.flowableprocess.listener.MyTaskListener&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">flowable:taskListener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的监听器代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskListener</span> <span class="keyword">implements</span> <span class="title class_">TaskListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当任务被创建的时候，这个方法会被触发</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delegateTask</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(DelegateTask delegateTask)</span> &#123;</span><br><span class="line">        <span class="comment">//可以在这里设置任务的处理人</span></span><br><span class="line">        delegateTask.setAssignee(<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>



<h4 id="设置为流程的发起人"><a href="#设置为流程的发起人" class="headerlink" title="设置为流程的发起人"></a>设置为流程的发起人</h4><p>首先在开始节点上，设置流程的发起人，这个地方给出的流程发起人，实际上是一个变量的名称，所以，这个名字怎么取都行。</p>
<div style="text-align:center">
  <style>.lpqulxbcozrs{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665909636067-7cfd5613-47f5-47b1-a17a-a546214160fc.png" class="lpqulxbcozrs" alt="img">
</div>

<p>然后，给 UserTask 设置处理人的时候，采用第二种方案，然后变量的名称就是发起人这个变量名称：</p>
<div style="text-align:center">
  <style>.zxggzlphxkfn{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665909762289-4e9316c3-5297-4922-8beb-718250c95a49.png" class="zxggzlphxkfn" alt="img">
</div>

<p>接下来，在流程启动的时候，需要指定流程的发起人：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动一个流程，并设置流程的发起人</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流程的发起人有两种不同的设置方式：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 第一种：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//设置流程当前的处理人（一会流程启动的时候，会将这里设置的作为流程的发起人）</span></span><br><span class="line">    Authentication.setAuthenticatedUserId(<span class="string">&quot;zhaoliu&quot;</span>);</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Authentication.setAuthenticatedUserId(&quot;zhaoliu&quot;);</code>实际上就是用来指定流程的发起人的。</p>
<p>第二种设置流程发起人的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">IdentityService identityService;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 第二种流程发起人的设置方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test07</span><span class="params">()</span> &#123;</span><br><span class="line">    identityService.setAuthenticatedUserId(<span class="string">&quot;fengqi&quot;</span>);</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h3 id="设置多个用户"><a href="#设置多个用户" class="headerlink" title="设置多个用户"></a>设置多个用户</h3><h4 id="直接指定"><a href="#直接指定" class="headerlink" title="直接指定"></a>直接指定</h4><p>直接指定多个候选用户：</p>
<div style="text-align:center">
  <style>.gbepjhyunrhd{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665918794085-7d571fe4-6824-4390-91fb-1260ffc0a6f6.png" class="gbepjhyunrhd" alt="img">
</div>

<p>对应的 XML 内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;UserTaskDemo&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserTaskDemo&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>UserTaskDemo<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:initiator</span>=<span class="string">&quot;INITATOR&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">name</span>=<span class="string">&quot;用户审批&quot;</span> <span class="attr">flowable:candidateUsers</span>=<span class="string">&quot;zhangsan,lisi,wangwu&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-3CC50988-362A-4917-8E96-7DC71CA18A76&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-4691C57C-BABD-4D39-BB14-FA2D78C951AE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-098AAEF6-D1F2-4CAB-B365-0C7A85353222&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-4691C57C-BABD-4D39-BB14-FA2D78C951AE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>flowable:candidateUsers=&quot;zhangsan,lisi,wangwu&quot;</code>就是设置流程可以由多个用户来处理，多个用户之间使用 <code>,</code>隔开。</p>
<p>接下来部署并启动流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>,pi.getId(),pi.getName());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>接下来，查询某一个用户需要处理的任务的时候，不能再继续使用之前的方案了，因为当一个 UserTask 有多个用户可以处理的时候，那么在 <code>ACT_RU_TASK</code>这个表中，是无法完全记录这个 Task 的处理人的，所以此时该表中的 <code>ASSIGNEE_</code>字段就为 null。</p>
<p>流程启动之后，如果想要根据用户名去查询该用户能够处理的<strong>任务</strong>，方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据候选人去查询任务</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 对应的 SQL 如下：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SELECT RES.* from ACT_RU_TASK RES WHERE RES.ASSIGNEE_ is null and exists(select LINK.ID_ from ACT_RU_IDENTITYLINK LINK </span></span><br><span class="line"><span class="comment"> * where LINK.TYPE_ = &#x27;candidate&#x27; and LINK.TASK_ID_ = RES.ID_ and ( LINK.USER_ID_ = ? ) ) order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 从 SQL 中 ，可以看到，任务由哪些用户来处理，主要是由 ACT_RU_IDENTITYLINK 表来维护。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test08</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(<span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;name:&#123;&#125;,CreateTime:&#123;&#125;&quot;</span>, task.getName(), task.getCreateTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>上面这个是根据候选人来查询一个任务。</strong></p>
<p>有的时候，我们已知流程的信息，想去查询流程的参与人，那么可以使用如下方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程的 ID 查询流程的参与者</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 对应的 SQL：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * select * from ACT_RU_IDENTITYLINK where PROC_INST_ID_ = ?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test09</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.createProcessInstanceQuery().singleResult();</span><br><span class="line">    <span class="comment">//根据流程的 ID 去查询流程的参与者</span></span><br><span class="line">    List&lt;IdentityLink&gt; links = runtimeService.getIdentityLinksForProcessInstance(pi.getId());</span><br><span class="line">    <span class="keyword">for</span> (IdentityLink link : links) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;流程参与人：&#123;&#125;&quot;</span>,link.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面这个查询中可以看到，<code>ACT_RU_IDENTITYLINK</code>表实际上有两方面的功能：</p>
<ul>
<li>记录了每一个 Task 的候选人 <code>TASK_ID_</code></li>
<li>记录了流程的参与人 <code>PROC_INST_ID_</code></li>
</ul>
<p>根据候选人找到 Task 之后，此时需要首先认领这个任务。认领的本质，其实就是给 <code>ACT_RU_TASK</code>表的 <code>ASSIGNEE_</code>字段设置值。</p>
<p>任务认领：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认领任务</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 这个认领，对应的 SQL：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * update ACT_RU_TASK SET REV_ = ?, ASSIGNEE_ = ?, CLAIM_TIME_ = ? where ID_= ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test10</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; tasks = taskService.createTaskQuery().taskCandidateUser(<span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">        <span class="comment">//认领，zhangsan 来认领这个任务</span></span><br><span class="line">        taskService.claim(task.getId(), <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>已经被认领的任务，能不能再次被认领？</p>
<p>已经被认领的任务，无法再次被认领，但是如果你认领了之后，又不想自己处理，可以使用之前说的委派的方式，交给其他人去处理。</p>
<p>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">            <span class="comment">//为某一个 Task 设置处理人</span></span><br><span class="line">            taskService.setAssignee(task.getId(), <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用变量或者监听器"><a href="#使用变量或者监听器" class="headerlink" title="使用变量或者监听器"></a>使用变量或者监听器</h4><h5 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h5><div style="text-align:center">
  <style>.emarbluhrzak{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665921474397-0ba3b619-6130-4aa5-8211-bcdbc6584f9d.png" class="emarbluhrzak" alt="img">
</div>

<p>将来启动流程的时候，必须要指定候选人：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test12</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//设置多个处理用户，多个处理用户之间用 , 隔开</span></span><br><span class="line">    vars.put(<span class="string">&quot;userIds&quot;</span>, <span class="string">&quot;zhangsan,lisi,wangwu&quot;</span>);</span><br><span class="line">    runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>, vars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="监听器"><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h5><p>也可以通过监听器来设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTaskCandidateUsersListener</span> <span class="keyword">implements</span> <span class="title class_">TaskListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(DelegateTask delegateTask)</span> &#123;</span><br><span class="line">        delegateTask.addCandidateUser(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        delegateTask.addCandidateUser(<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        delegateTask.addCandidateUser(<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后删除掉任务的处理人，再为任务设置监听器。</p>
<p>接下来启动处理，和前面基本一致。</p>
<h4 id="任务回退"><a href="#任务回退" class="headerlink" title="任务回退"></a>任务回退</h4><p>就是已经认领的任务，再退回去（这样其他人就可以认领了）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务回退</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 对应的 SQL 如下：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * update ACT_RU_TASK SET REV_ = ?, ASSIGNEE_ = ? where ID_= ? and REV_ = ?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test13</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Task&gt; tasks = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;lisi&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">        <span class="comment">//设置任务的处理人为 null，就表示任务回退</span></span><br><span class="line">        taskService.setAssignee(task.getId(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>

<h4 id="流程候选人的添加与删除"><a href="#流程候选人的添加与删除" class="headerlink" title="流程候选人的添加与删除"></a>流程候选人的添加与删除</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除一个任务的候选人</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 对应的 SQL 如下：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * delete from ACT_RU_IDENTITYLINK where ID_ = ?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 实际上，是根据 wangwu + taskId 去 ACT_RU_IDENTITYLINK 表中查询到记录的详细信息 select * from ACT_RU_IDENTITYLINK where TASK_ID_ = ? and USER_ID_ = ? and TYPE_ = ?，然后再去删除</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test15</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().singleResult();</span><br><span class="line">    taskService.deleteCandidateUser(task.getId(),<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为任务增加候选人</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 对应的 SQL 如下：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * insert into ACT_RU_IDENTITYLINK (ID_, REV_, TYPE_, USER_ID_, GROUP_ID_, TASK_ID_, PROC_INST_ID_, PROC_DEF_ID_, SCOPE_ID_, SUB_SCOPE_ID_, SCOPE_TYPE_, SCOPE_DEFINITION_ID_) </span></span><br><span class="line"><span class="comment"> * values (?, 1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) , (?, 1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test14</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().singleResult();</span><br><span class="line">    taskService.addCandidateUser(task.getId(), <span class="string">&quot;zhaoliu&quot;</span>);</span><br><span class="line">    taskService.addCandidateUser(task.getId(), <span class="string">&quot;javaboy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h3 id="按照角色分配任务处理人"><a href="#按照角色分配任务处理人" class="headerlink" title="按照角色分配任务处理人"></a>按照角色分配任务处理人</h3><p>先准备数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建 zhangsan 和 lisi 两个用户</span></span><br><span class="line"><span class="comment"> * 创建名为 g1 的用户组</span></span><br><span class="line"><span class="comment"> * 设置 zhangsan 和 lisi 都属于 g1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test16</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">UserEntityImpl</span> <span class="variable">u1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEntityImpl</span>();</span><br><span class="line">    u1.setRevision(<span class="number">0</span>);</span><br><span class="line">    u1.setEmail(<span class="string">&quot;zhangsan@qq.com&quot;</span>);</span><br><span class="line">    u1.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    u1.setId(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    u1.setDisplayName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">    identityService.saveUser(u1);</span><br><span class="line">    <span class="type">UserEntityImpl</span> <span class="variable">u2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEntityImpl</span>();</span><br><span class="line">    u2.setRevision(<span class="number">0</span>);</span><br><span class="line">    u2.setEmail(<span class="string">&quot;lisi@qq.com&quot;</span>);</span><br><span class="line">    u2.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    u2.setId(<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    u2.setDisplayName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">    identityService.saveUser(u2);</span><br><span class="line">    <span class="type">GroupEntityImpl</span> <span class="variable">g1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupEntityImpl</span>();</span><br><span class="line">    g1.setRevision(<span class="number">0</span>);</span><br><span class="line">    g1.setId(<span class="string">&quot;manager&quot;</span>);</span><br><span class="line">    g1.setName(<span class="string">&quot;经理&quot;</span>);</span><br><span class="line">    identityService.saveGroup(g1);</span><br><span class="line">    identityService.createMembership(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;manager&quot;</span>);</span><br><span class="line">    identityService.createMembership(<span class="string">&quot;lisi&quot;</span>, <span class="string">&quot;manager&quot;</span>);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>



<p>可以直接指定组名称，也可以通过变量来指定。</p>
<p> 直接指定名称 </p>
<div style="text-align:center">
  <style>.ejlufobgdpca{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665924710756-07725b25-c39b-41e4-afcb-3e120274a1c8.png" class="ejlufobgdpca" alt="image.png">
</div>



<p>对应的 XML 文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;UserTaskDemo&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserTaskDemo&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>UserTaskDemo<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:initiator</span>=<span class="string">&quot;INITATOR&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">name</span>=<span class="string">&quot;用户审批&quot;</span> <span class="attr">flowable:candidateGroups</span>=<span class="string">&quot;manager&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-3CC50988-362A-4917-8E96-7DC71CA18A76&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-4691C57C-BABD-4D39-BB14-FA2D78C951AE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-098AAEF6-D1F2-4CAB-B365-0C7A85353222&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-4691C57C-BABD-4D39-BB14-FA2D78C951AE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中，<code>flowable:candidateGroups=&quot;manager&quot;</code>就是用来指定候选组。</p>
<p>接下来，可以根据候选用户去查询任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据候选人去查询任务（可能 zhangsan 就是候选人，也可能 zhangsan 属于某一个或者某多个用户组，那么此时就需要先查询到 zhangsan 所属的用户组，然后再根据用户组去查询对应的任务）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 这个查询实际上分为两步：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. 执行的 SQL 如下：SELECT RES.* from ACT_ID_GROUP RES WHERE exists(select 1 from ACT_ID_MEMBERSHIP M where M.GROUP_ID_ = RES.ID_ and M.USER_ID_ = ?) order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * 第一步这个 SQL 可以查询出来这个 zhangsan 所属的用户组</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2. 执行的 SQL 如下：</span></span><br><span class="line"><span class="comment"> * SELECT RES.* from ACT_RU_TASK RES WHERE RES.ASSIGNEE_ is null and</span></span><br><span class="line"><span class="comment"> * exists(select LINK.ID_ from ACT_RU_IDENTITYLINK LINK where LINK.TYPE_ = &#x27;candidate&#x27; and LINK.TASK_ID_ = RES.ID_ and</span></span><br><span class="line"><span class="comment"> * ( LINK.USER_ID_ = ? or ( LINK.GROUP_ID_ IN ( ? ) ) ) ) order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 综上： 【这个 SQL，本质上是查询 zhangsan 或者 zhangsan 所属的用户组的任务】</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test17</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().taskCandidateUser(<span class="string">&quot;zhangsan&quot;</span>).singleResult();</span><br><span class="line">    logger.info(<span class="string">&quot;name:&#123;&#125;,createTime:&#123;&#125;&quot;</span>, task.getName(), task.getCreateTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以根据候选组去查询任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 也可以根据候选用户组去查询一个任务</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 对应的 SQL 如下：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * SELECT RES.* from ACT_RU_TASK RES WHERE RES.ASSIGNEE_ is null and exists(select LINK.ID_ from ACT_RU_IDENTITYLINK LINK where LINK.TYPE_ = &#x27;candidate&#x27; </span></span><br><span class="line"><span class="comment"> * and LINK.TASK_ID_ = RES.ID_ and ( ( LINK.GROUP_ID_ IN ( ? ) ) ) ) order by RES.ID_ asc</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 这个查询一步到位，直接指定候选组即可</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test18</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().taskCandidateGroup(<span class="string">&quot;manager&quot;</span>).singleResult();</span><br><span class="line">    logger.info(<span class="string">&quot;name:&#123;&#125;,createTime:&#123;&#125;&quot;</span>, task.getName(), task.getCreateTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种任务在具体执行的过程中，也需要<strong>先认领，再执行</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">Test19</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().taskCandidateGroup(<span class="string">&quot;manager&quot;</span>).singleResult();</span><br><span class="line">    taskService.claim(task.getId(),<span class="string">&quot;zhangsan&quot;</span>);<span class="comment">//认领</span></span><br><span class="line">    taskService.complete(task.getId());<span class="comment">//执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<br>

<h5 id="通过变量来指定"><a href="#通过变量来指定" class="headerlink" title="通过变量来指定"></a>通过变量来指定</h5><div style="text-align:center">
  <style>.ltdblllgldxt{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/1665925919871-2174c143-d068-4e4b-8bd2-ef97b7af2d70.png" class="ltdblllgldxt" alt="img">
</div>

<p>对应的 XML 如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;UserTaskDemo&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserTaskDemo&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>UserTaskDemo<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:initiator</span>=<span class="string">&quot;INITATOR&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">name</span>=<span class="string">&quot;用户审批&quot;</span> <span class="attr">flowable:candidateGroups</span>=<span class="string">&quot;$&#123;g&#125;&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-3CC50988-362A-4917-8E96-7DC71CA18A76&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-4691C57C-BABD-4D39-BB14-FA2D78C951AE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-098AAEF6-D1F2-4CAB-B365-0C7A85353222&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-E37FEEFF-D8D5-4450-9D2D-67F9B2EBEE2A&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-4691C57C-BABD-4D39-BB14-FA2D78C951AE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>设置用户组的位置 <code>flowable:candidateGroups=&quot;$&#123;g&#125;&quot;</code>。</p>
<p>启动流程的时候，为用户组设置变量值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test20</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    vars.put(<span class="string">&quot;g&quot;</span>, <span class="string">&quot;manager&quot;</span>);</span><br><span class="line">    <span class="type">ProcessInstance</span> <span class="variable">pi</span> <span class="operator">=</span> runtimeService.startProcessInstanceByKey(<span class="string">&quot;UserTaskDemo&quot;</span>,vars);</span><br><span class="line">    logger.info(<span class="string">&quot;id:&#123;&#125;,name:&#123;&#125;&quot;</span>, pi.getId(), pi.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ServiceTask"><a href="#ServiceTask" class="headerlink" title="ServiceTask"></a>ServiceTask</h2><p>服务任务：由系统自动完成的任务，流程走到这一步的时候，会自动执行下一步，而不会停下来。</p>
<h3 id="监听类"><a href="#监听类" class="headerlink" title="监听类"></a>监听类</h3><p>首先定义一个监听器类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这是我们自定义的监听器类，这个类也就是 ServiceTask 执行到这里的时候，会自动执行该类中的 execute 方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceTask01</span> <span class="keyword">implements</span> <span class="title class_">JavaDelegate</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(DelegateExecution execution)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=============MyServiceTask01=============&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在绘制流程图的时候，为 ServiceTask 配置监听器类：</p>
<div style="text-align:center">
  <style>.dopieqdiajun{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221107165800284.png" class="dopieqdiajun" alt="image-20221107165800284">
</div>

<p> 流程对应的XML文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ServiceTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-C6258E73-95C1-44EB-8AE9-8ECEE426833B&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">serviceTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span> <span class="attr">flowable:class</span>=<span class="string">&quot;com.lcdzzz.flowableprocess.servicetask.MyServiceTask01&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">serviceTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-0EF3775F-8202-49EB-86CB-8705A50B9E31&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-98FB240A-C264-4947-9063-9B686A366FF5&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-0EF3775F-8202-49EB-86CB-8705A50B9E31&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>关键指令： <code>flowable:class=&quot;com.lcdzzz.flowableprocess.servicetask.MyServiceTask01&quot;</code>。</p>
<p>流程测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceTaskTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">        runtimeService.startProcessInstanceByKey(<span class="string">&quot;ServiceTaskDemo01&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这个流程测试只有一个 ServiceTask 这个节点，所以流程启动成功之后，就会自动执行完毕！</p>
<blockquote>
<p>注意，ServiceTask 在执行的过程中，任务的记录是不会保存到 <code>ACT_RU_TASK</code>表中的，这一点与 UserTask 不同。</p>
</blockquote>
<br>

<h4 id="为类设置字段"><a href="#为类设置字段" class="headerlink" title="为类设置字段"></a>为类设置字段</h4><div style="text-align:center">
  <style>.rqodxpaxuicf{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109201731255.png" class="rqodxpaxuicf" alt="image-20221109201731255">
</div>

<p>双击“未选择字段”</p>
<div style="text-align:center">
  <style>.xywfibuvaztj{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109201846600.png" class="xywfibuvaztj" alt="image-20221109201846600">
</div>

<p>流程图对应的 XML 文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ServiceTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-C6258E73-95C1-44EB-8AE9-8ECEE426833B&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">serviceTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span> <span class="attr">flowable:class</span>=<span class="string">&quot;com.lcdzzz.flowableprocess.servicetask.MyServiceTask01&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">flowable:field</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">flowable:string</span>&gt;</span>&lt;![CDATA[javaboy]]&gt;<span class="tag">&lt;/<span class="name">flowable:string</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">flowable:field</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">serviceTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-0EF3775F-8202-49EB-86CB-8705A50B9E31&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-98FB240A-C264-4947-9063-9B686A366FF5&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-0EF3775F-8202-49EB-86CB-8705A50B9E31&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来，在这个监听器类中，就可以获取到 username 的值了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这是我们自定义的监听器类，这个类也就是 ServiceTask 执行到这里的时候，会自动执行该类中的 execute 方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceTask01</span> <span class="keyword">implements</span> <span class="title class_">JavaDelegate</span> &#123;</span><br><span class="line"></span><br><span class="line">    Expression username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(DelegateExecution execution)</span> &#123;</span><br><span class="line">        <span class="comment">//获取 username 的值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;username.getExpressionText() = &quot;</span> + username.getExpressionText());</span><br><span class="line">        System.out.println(<span class="string">&quot;username.getValue(execution) = &quot;</span> + username.getValue(execution));</span><br><span class="line">        System.out.println(<span class="string">&quot;=============MyServiceTask01=============&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="委托表达式"><a href="#委托表达式" class="headerlink" title="委托表达式"></a>委托表达式</h3><p>委托表达式类似于监听器类，但是，这种表达式，可以将类注册到 Spring 容器中，然后在给流程图配置的时候，直接配置 Spring 容器中 Bean 的名称即可。</p>
<p>监听器类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceTask02</span> <span class="keyword">implements</span> <span class="title class_">JavaDelegate</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(DelegateExecution execution)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=============MyServiceTask02==============&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与上一小节相比，这里通过<code>@Component</code>注解将 MyServiceTask02 注册到 Spring 容器中了。这样，在流程图中，可以直接配置 Bean 的名称即可：</p>
<div style="text-align:center">
  <style>.ougceklnzjka{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109205340163.png" class="ougceklnzjka" alt="image-20221109205340163">
</div>

<p>流程图对应的XML内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ServiceTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-C6258E73-95C1-44EB-8AE9-8ECEE426833B&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">serviceTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span> <span class="attr">flowable:delegateExpression</span>=<span class="string">&quot;$&#123;myServiceTask02&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">serviceTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-0EF3775F-8202-49EB-86CB-8705A50B9E31&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-98FB240A-C264-4947-9063-9B686A366FF5&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-768328FE-5C7F-4DF5-B145-18F5B206EC9C&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-0EF3775F-8202-49EB-86CB-8705A50B9E31&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>flowable:delegateExpression=&quot;$&#123;myServiceTask02&#125;&quot;</code>则描述了执行对应的 ServiceTask 的 Bean。</p>
<h3 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h3><p>前面两种，无论是直接配置类的全路径，还是配置 Bean 的名称，都离不开 <code>JavaDelegate</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceTask03</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=============MyServiceTask03=============&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<div style="text-align:center">
  <style>.plzculrvifix{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109224233835.png" class="plzculrvifix" alt="image-20221109224233835">
</div>

<div style="text-align:center">
  <style>.dsajoktimfnx{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109224451560.png" class="dsajoktimfnx" alt="image-20221109224451560">
</div>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ServiceTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ServiceTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-BF8668E7-6CA2-4F17-BD6B-0D0E17FB1C48&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-F580AD28-4492-453D-B359-88F001EE4FB7&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serviceTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-F580AD28-4492-453D-B359-88F001EE4FB7&quot;</span> <span class="attr">flowable:expression</span>=<span class="string">&quot;$&#123;myServiceTask03.hello()&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">serviceTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-E1732394-8FED-4FF8-9372-B62BAD7DA1C7&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-0EDD436D-7E0D-4D4C-BC67-0CD2BE26AA4B&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-F580AD28-4492-453D-B359-88F001EE4FB7&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E1732394-8FED-4FF8-9372-B62BAD7DA1C7&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 注意，我们在 6.2.1 小节中介绍的给监听器类设置字段的功能，并不适用于表达式这种情况。</p>
</blockquote>
<h2 id="ScriptTask"><a href="#ScriptTask" class="headerlink" title="ScriptTask"></a>ScriptTask</h2><p>脚本任务和 ServiceTask 类似，也是自动执行的。不同的是，脚本任务的逻辑，是通过一些非 Java 的脚本语言来实现的。</p>
<h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><div style="text-align:center">
  <style>.jphrjiodioau{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109234214460.png" class="jphrjiodioau" alt="image-20221109234214460">
</div>

<div style="text-align:center">
  <style>.xnmcrgormvlu{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221109234150384.png" class="xnmcrgormvlu" alt="image-20221109234150384">
</div>

<ul>
<li>第一行执行一个加法运算。</li>
<li>第二行往流程中保存一个名为 sum 的流程变量。</li>
</ul>
<p>对应的 XML：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ScriptTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ScriptTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ScriptTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-3B965318-F1BE-4155-A599-69B76A93878A&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-2690302E-6E4C-4C46-A1E3-7B12F446F667&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-B85B82DB-E801-41EC-ABE2-391947D45055&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-F9A7C6C2-5734-4E69-9D15-45B55D3A4D18&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-2690302E-6E4C-4C46-A1E3-7B12F446F667&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-B85B82DB-E801-41EC-ABE2-391947D45055&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-2690302E-6E4C-4C46-A1E3-7B12F446F667&quot;</span> <span class="attr">scriptFormat</span>=<span class="string">&quot;JavaScript&quot;</span> <span class="attr">flowable:autoStoreVariables</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">&lt;![CDATA[var sum=a+b;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">execution.setVariable(&quot;sum&quot;,sum);]]&gt;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scriptTask</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 注意，这个脚本在使用的使用，还不能够使用 let 关键字，可以使用 var 关键字</p>
</blockquote>
<h3 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h3><p>Groovy 是基于 JVM 的编程语言。</p>
<p>使用 Groovy 需要首先添加依赖：</p>
<div style="text-align:center">
  <style>.mcrigohhglth{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110122530248.png" class="mcrigohhglth" alt="image-20221110122530248">
</div>

<div style="text-align:center">
  <style>.lqlwxcnpmgok{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110122448348.png" class="lqlwxcnpmgok" alt="image-20221110122448348">
</div>

<p>对应的XML文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ScriptTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ScriptTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ScriptTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-22A421AF-289E-42C2-A68D-0B91A4A7E7C4&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-419BE2B8-7C87-4BF5-98BC-5E535F1D00D0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-419BE2B8-7C87-4BF5-98BC-5E535F1D00D0&quot;</span> <span class="attr">scriptFormat</span>=<span class="string">&quot;Groovy&quot;</span> <span class="attr">flowable:autoStoreVariables</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">&lt;![CDATA[System.out.println(&quot;hello groovy&quot;);]]&gt;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scriptTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-E5DF61BE-B05E-4B4B-A775-F5C3812B132C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-B2EB7E48-C6A2-41FB-A660-DAFABF0B8526&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-419BE2B8-7C87-4BF5-98BC-5E535F1D00D0&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E5DF61BE-B05E-4B4B-A775-F5C3812B132C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Juel"><a href="#Juel" class="headerlink" title="Juel"></a>Juel</h3><p>Juel 全称 Java Unified Expression Language。</p>
<p>之前我们写的表达式 ${xxx} 这就是一个 Juel。</p>
<p>比如我想调用下图MyServiceTask03的hello()方法</p>
<div style="text-align:center">
  <style>.ificztkkpvcj{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110123225032.png" class="ificztkkpvcj" alt="image-20221110123225032">
</div>

<p>脚本下</p>
<p>这个脚本就表示执行 Spring 容器中的一个名为 myServiceTask03 的 Bean 的 hello 方法。</p>
<div style="text-align:center">
  <style>.shwqstnugrbf{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110123540728.png" class="shwqstnugrbf" alt="image-20221110123540728">
</div>

<div style="text-align:center">
  <style>.yqiehvpgvmwi{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110123447020.png" class="yqiehvpgvmwi" alt="image-20221110123447020">
</div>

<p>对应的 XML 文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ScriptTaskDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ScriptTaskDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ScriptTaskDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-22A421AF-289E-42C2-A68D-0B91A4A7E7C4&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-419BE2B8-7C87-4BF5-98BC-5E535F1D00D0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-419BE2B8-7C87-4BF5-98BC-5E535F1D00D0&quot;</span> <span class="attr">scriptFormat</span>=<span class="string">&quot;juel&quot;</span> <span class="attr">flowable:autoStoreVariables</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">&lt;![CDATA[$&#123;myServiceTask03.hello()&#125;]]&gt;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scriptTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-E5DF61BE-B05E-4B4B-A775-F5C3812B132C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-B2EB7E48-C6A2-41FB-A660-DAFABF0B8526&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-419BE2B8-7C87-4BF5-98BC-5E535F1D00D0&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E5DF61BE-B05E-4B4B-A775-F5C3812B132C&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<br>

<br>

<h1 id="网关-1"><a href="#网关-1" class="headerlink" title="网关"></a>网关</h1><h2 id="排他网关"><a href="#排他网关" class="headerlink" title="排他网关"></a>排他网关</h2><p>排他网关也叫互斥网关，互斥网关可以有 N 多个入口，但是只有一个有效出口。</p>
<p>假设我们有一个请假流程，这个请假流程执行的过程中，分三种情况：</p>
<ol>
<li>请假小于等于 1 天，组长审批。</li>
<li>大于 1 天，小于等于 3 天，经理审批。</li>
<li>大于 3 天，总监审批。</li>
</ol>
<div style="text-align:center">
  <style>.iumhhsrcmnoa{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110204941346.png" class="iumhhsrcmnoa" alt="image-20221110204941346">
</div>

<p>可以看到，互斥网关可以有 N 多个入口，上图中虽然画出来了三个出口，但是在实际执行中，三个出口只有一个是有效出口。</p>
<p>通过连接线上的流条件，来设置流程的执行：</p>
<div style="text-align:center">
  <style>.dthtwtlnnoxw{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110205226324.png" class="dthtwtlnnoxw" alt="image-20221110205226324">
</div>

<div style="text-align:center">
  <style>.bgifumpuitba{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110205424318.png" class="bgifumpuitba" alt="image-20221110205424318">
</div>

<div style="text-align:center">
  <style>.pookmbexcqyw{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110205436200.png" class="pookmbexcqyw" alt="image-20221110205436200">
</div>

<p>对应的 XML 文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ExclusiveGatewayDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ExclusiveGatewayDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ExclusiveGatewayDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">exclusiveGateway</span> <span class="attr">id</span>=<span class="string">&quot;sid-A53B391A-3E1C-4622-A546-144B55BC4360&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">exclusiveGateway</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-DF8E49A5-20F5-4BF8-A89F-91B77E83D23A&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-A53B391A-3E1C-4622-A546-144B55BC4360&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-5C7D775C-4893-475D-9C91-F4FE8BF7BAB4&quot;</span> <span class="attr">name</span>=<span class="string">&quot;组长审批&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-93654C2E-8373-4DDD-8B37-6268C9E46B00&quot;</span> <span class="attr">name</span>=<span class="string">&quot;经理审批&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-13C8B753-6D18-4742-846B-8EE2CA905CE4&quot;</span> <span class="attr">name</span>=<span class="string">&quot;总监审批&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-B71EC429-6213-411B-A761-492224D5ED14&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-43D5DFA2-3670-4D5F-AEAF-4F02DF05BCF1&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-5C7D775C-4893-475D-9C91-F4FE8BF7BAB4&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-B71EC429-6213-411B-A761-492224D5ED14&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-5ED92318-E5FD-4988-BACC-DE195B759CE8&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-93654C2E-8373-4DDD-8B37-6268C9E46B00&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-B71EC429-6213-411B-A761-492224D5ED14&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-B17E4938-5ABA-4092-9C26-27AD71FE3BD9&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-13C8B753-6D18-4742-846B-8EE2CA905CE4&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-B71EC429-6213-411B-A761-492224D5ED14&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-114747E0-9717-4E59-8254-F2FC8CA8ABF1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;大于1小于等于3&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-A53B391A-3E1C-4622-A546-144B55BC4360&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-93654C2E-8373-4DDD-8B37-6268C9E46B00&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">&quot;tFormalExpression&quot;</span>&gt;</span>&lt;![CDATA[$&#123;days&gt;1 &amp;&amp; days&lt;=3&#125;]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-A6412882-BAA1-484F-AD31-912A9FD2CCA3&quot;</span> <span class="attr">name</span>=<span class="string">&quot;大于3&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-A53B391A-3E1C-4622-A546-144B55BC4360&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-13C8B753-6D18-4742-846B-8EE2CA905CE4&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">&quot;tFormalExpression&quot;</span>&gt;</span>&lt;![CDATA[$&#123;days&gt;3&#125;]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-4CCE2748-C505-4457-BE12-96915A5A1EBD&quot;</span> <span class="attr">name</span>=<span class="string">&quot;小于等于1&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-A53B391A-3E1C-4622-A546-144B55BC4360&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-5C7D775C-4893-475D-9C91-F4FE8BF7BAB4&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">&quot;tFormalExpression&quot;</span>&gt;</span>&lt;![CDATA[$&#123;days&lt;=1&#125;]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>sequenceFlow</code>标签中，有一个 <code>conditionExpression</code>标签，这个标签专门用来设置流程执行的条件。</p>
<p>流程启动的时候，传入 days 变量即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    HashMap&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    vars.put(<span class="string">&quot;days&quot;</span>,<span class="number">10</span>);</span><br><span class="line">    runtimeService.startProcessInstanceByKey(<span class="string">&quot;ExclusiveGatewayDemo01&quot;</span>,vars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="并行网关"><a href="#并行网关" class="headerlink" title="并行网关"></a>并行网关</h2><p>多个任务同时执行，并且多个任务全部都执行完毕的时候，才会进入到下一个任务。</p>
<p>另外还需要注意一点就是，并行网关一般来说是成对出现的。</p>
<div style="text-align:center">
  <style>.hkimtefecnel{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110214343949.png" class="hkimtefecnel" alt="image-20221110214343949">
</div>

<p>这里大家需要注意的是，并行网关是成对出现的（节点连线上不需要设置条件）。<br>流程对应的 XML 文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;ParallelGatewayDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ParallelGatewayDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>ParallelGatewayDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-A8805B16-FABA-4E1A-A376-B0482F0832B8&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-1E9B605C-4F94-407F-AE6F-36768E04B116&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parallelGateway</span> <span class="attr">id</span>=<span class="string">&quot;sid-1E9B605C-4F94-407F-AE6F-36768E04B116&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">parallelGateway</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-4B2B7E70-55A9-4C68-B622-0E041AA81CBF&quot;</span> <span class="attr">name</span>=<span class="string">&quot;生产屏幕&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;zhangsan&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-C3E727EC-B5A6-4D01-8CEE-2A67BAB8C2C0&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-1E9B605C-4F94-407F-AE6F-36768E04B116&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-4B2B7E70-55A9-4C68-B622-0E041AA81CBF&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-F43618C6-213E-4EC0-A6AB-1F31D9B2FD79&quot;</span> <span class="attr">name</span>=<span class="string">&quot;生产键盘&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;lisi&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-417FC68C-4759-4186-8978-AABAFC0D3E7B&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-1E9B605C-4F94-407F-AE6F-36768E04B116&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-F43618C6-213E-4EC0-A6AB-1F31D9B2FD79&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-A69B4FC7-6E1D-4087-ADF4-F6FFC0319388&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-4B2B7E70-55A9-4C68-B622-0E041AA81CBF&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-FAE8927E-1F6B-4F80-BB4C-39D5ADF63BED&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parallelGateway</span> <span class="attr">id</span>=<span class="string">&quot;sid-FAE8927E-1F6B-4F80-BB4C-39D5ADF63BED&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">parallelGateway</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-F54298A2-9484-4708-8026-BBAA386686F3&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-F43618C6-213E-4EC0-A6AB-1F31D9B2FD79&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-FAE8927E-1F6B-4F80-BB4C-39D5ADF63BED&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-EA0ED8A8-FAF3-470B-8E1C-A7594A69F2B5&quot;</span> <span class="attr">name</span>=<span class="string">&quot;组装&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;wangwu&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-9CE61BAA-1038-4806-97DC-1DDB26F5F318&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-FAE8927E-1F6B-4F80-BB4C-39D5ADF63BED&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-EA0ED8A8-FAF3-470B-8E1C-A7594A69F2B5&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-19015D6D-1A47-4DD5-AEAA-DCC93FD5CAB0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-100E5221-CE66-4C2D-802B-DE8717AFE777&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-EA0ED8A8-FAF3-470B-8E1C-A7594A69F2B5&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-19015D6D-1A47-4DD5-AEAA-DCC93FD5CAB0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>不需要参数，所以直接运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        runtimeService.startProcessInstanceByKey(<span class="string">&quot;ParallelGatewayDemo01&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>只有zhangsan和lisi都执行完，才会进入到wangwu部分</p>
<h2 id="包容网关"><a href="#包容网关" class="headerlink" title="包容网关"></a>包容网关</h2><p>包容官网，有时候也叫兼容网关、相容网关。</p>
<p>包容网关可以根据具体的条件，自动转为排他网关或者是并行网关。</p>
<p>举例：</p>
<p>报销，小于等于 500 元，zhangsan 审批，大于 500 元，zhangsan 和 lisi 同时审批。</p>
<p>流程图如下：</p>
<div style="text-align:center">
  <style>.ojkwspyuhsdx{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110223602083.png" class="ojkwspyuhsdx" alt="image-20221110223602083">
</div>

<p>设置的流程条件如下：</p>
<div style="text-align:center">
  <style>.sxzvngmttnny{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110223634830.png" class="sxzvngmttnny" alt="image-20221110223634830">
</div>

<div style="text-align:center">
  <style>.gbjcveywgizv{width:70%}</style><img src="/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/image-20221110223705603.png" class="gbjcveywgizv" alt="image-20221110223705603">
</div>

<ol>
<li>报销 400 元的时候，只满足 &gt; 0，所以是 zhangsan 审批，此时是拍他网关。</li>
<li>报销 600 元的时候，既满足 &gt;0，又满足 &gt;500，此时就是 zhangsan 和 lisi 同时审批。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;InclusiveGatewayDemo01&quot;</span> <span class="attr">name</span>=<span class="string">&quot;InclusiveGatewayDemo01&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>InclusiveGatewayDemo01<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-8CD8CA6A-3897-4245-9501-42439302DABA&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startEvent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-C394FFAE-9804-499B-965B-2E75A49180C2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">inclusiveGateway</span> <span class="attr">id</span>=<span class="string">&quot;sid-C394FFAE-9804-499B-965B-2E75A49180C2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">inclusiveGateway</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-E867D477-AEF1-4281-B078-CB507D22951E&quot;</span> <span class="attr">name</span>=<span class="string">&quot;张三审批&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;zhangsan&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-667FC03A-321D-4DFA-9B07-30434B42058C&quot;</span> <span class="attr">name</span>=<span class="string">&quot;李四审批&quot;</span> <span class="attr">flowable:assignee</span>=<span class="string">&quot;lisi&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">&quot;http://flowable.org/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-5BC666E9-F5D6-458F-8601-BEBEA786298D&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-E867D477-AEF1-4281-B078-CB507D22951E&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-A7944F49-D14D-4CCE-AC25-C194A8E89678&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">inclusiveGateway</span> <span class="attr">id</span>=<span class="string">&quot;sid-A7944F49-D14D-4CCE-AC25-C194A8E89678&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">inclusiveGateway</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-D78198C3-4023-4724-A3AE-4797304C17A0&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-667FC03A-321D-4DFA-9B07-30434B42058C&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-A7944F49-D14D-4CCE-AC25-C194A8E89678&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;sid-6FBB65EA-6A83-4CC9-AC6F-CD443D38F7D5&quot;</span> <span class="attr">name</span>=<span class="string">&quot;王五审批&quot;</span> <span class="attr">flowable:formFieldValidation</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-795CBE0B-19DA-4B72-A12E-5FB3A4B92A3D&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-A7944F49-D14D-4CCE-AC25-C194A8E89678&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-6FBB65EA-6A83-4CC9-AC6F-CD443D38F7D5&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;sid-010A170E-8468-45F9-94D9-962B44F25381&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-564DEEB3-0778-460E-AEEA-22787300E17E&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-6FBB65EA-6A83-4CC9-AC6F-CD443D38F7D5&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-010A170E-8468-45F9-94D9-962B44F25381&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-481CB3EF-5254-4514-AA29-DE268FD6EE32&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-C394FFAE-9804-499B-965B-2E75A49180C2&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-E867D477-AEF1-4281-B078-CB507D22951E&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">&quot;tFormalExpression&quot;</span>&gt;</span>&lt;![CDATA[$&#123;money&gt;0&#125;]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;sid-9C2BBBF9-C313-489D-87C4-61AB56415A0C&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;sid-C394FFAE-9804-499B-965B-2E75A49180C2&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;sid-667FC03A-321D-4DFA-9B07-30434B42058C&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">&quot;tFormalExpression&quot;</span>&gt;</span>&lt;![CDATA[$&#123;money&gt;500&#125;]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>开始流程。money是1000，大于500并且大于0，所以应该需要zhangsan和lisi都审批（并行），最后王五审批</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">       HashMap&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       vars.put(<span class="string">&quot;money&quot;</span>,<span class="number">1000</span>);</span><br><span class="line">       runtimeService.startProcessInstanceByKey(<span class="string">&quot;InclusiveGatewayDemo01&quot;</span>,vars);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>执行。只有zhangsan和lisi都执行了，才轮到wangwu，最后wangwu执行，流程结束</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(<span class="string">&quot;zhangsan&quot;</span>).list();</span><br><span class="line"><span class="comment">//        List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(&quot;lisi&quot;).list();</span></span><br><span class="line"><span class="comment">//        List&lt;Task&gt; list = taskService.createTaskQuery().taskAssignee(&quot;wangwu&quot;).list();</span></span><br><span class="line">        <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line">            <span class="comment">//查询到 zhangsan 的任务，并自己处理</span></span><br><span class="line">            taskService.complete(task.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="流程变量"><a href="#流程变量" class="headerlink" title="流程变量"></a>流程变量</h1><p>流程变量的分类：</p>
<ol>
<li>全局流程变量</li>
<li>本地流程变量</li>
<li>临时流程变量</li>
</ol>
<p>在之前的案例中，凡是涉及到流程变量的地方，基本上都是全局流程变量。</p>
<h2 id="全局流程变量"><a href="#全局流程变量" class="headerlink" title="全局流程变量"></a>全局流程变量</h2><p>注意，以下四种方式，都是设置全局流程变量。无论是通过哪种方式设置，本质上都是全局流程变量，这个不会变。全局流程变量，顾名思义，就是和流程实例&#x2F;执行实例绑定的流程变量，和某个具体的 UserTask 是没有关系的。</p>
<h3 id="启动时候设置"><a href="#启动时候设置" class="headerlink" title="启动时候设置"></a>启动时候设置</h3><p>流程启动的时候，设置全局流程变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在流程启动的时候，就可以设置流程变量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流程变量将被存入到两个地方：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. ACT_HI_VARINST：存入到历史信息表中，将来可以从历史表中查询到流程变量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * insert into ACT_HI_VARINST (ID_, PROC_INST_ID_, EXECUTION_ID_, TASK_ID_, NAME_, REV_, VAR_TYPE_, SCOPE_ID_, SUB_SCOPE_ID_, SCOPE_TYPE_, BYTEARRAY_ID_, DOUBLE_, LONG_ , TEXT_, TEXT2_, CREATE_TIME_, LAST_UPDATED_TIME_) values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) , ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) , ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) , ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2. ACT_RU_VARIABLE：流程运行的信息表，流程运行的变量将存入到这个表中</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * INSERT INTO ACT_RU_VARIABLE (ID_, REV_, TYPE_, NAME_, PROC_INST_ID_, EXECUTION_ID_, TASK_ID_, SCOPE_ID_, SUB_SCOPE_ID_, SCOPE_TYPE_, BYTEARRAY_ID_, DOUBLE_, LONG_ , TEXT_, TEXT2_) VALUES ( ?, 1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) , ( ?, 1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) , ( ?, 1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) , ( ?, 1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    vars.put(<span class="string">&quot;days&quot;</span>, <span class="number">10</span>);</span><br><span class="line">    vars.put(<span class="string">&quot;reason&quot;</span>, <span class="string">&quot;玩一下&quot;</span>);</span><br><span class="line">    vars.put(<span class="string">&quot;startTime&quot;</span>, <span class="string">&quot;2022-10-30&quot;</span>);</span><br><span class="line">    vars.put(<span class="string">&quot;endTime&quot;</span>, <span class="string">&quot;2022-11-09&quot;</span>);</span><br><span class="line">    <span class="comment">//这个就是在启动的时候设置流程变量，这里设置的流程变量是一个全局的流程变量</span></span><br><span class="line">    runtimeService.startProcessInstanceByKey(<span class="string">&quot;VariableDemo&quot;</span>,vars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程变量会被存入到两个地方，RU 和 HI 表中，然后，我们可以通过流程执行实例 ID【就是<code>ACT_RU_EXECUTION</code>表的<code>ID_</code>字段】 来查询流程变量信息：中的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过执行实例 ID  可以查询流程变量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 具体的查询 SQL：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * select * from ACT_RU_VARIABLE WHERE EXECUTION_ID_ = ? AND TASK_ID_ is null AND NAME_ = ?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; list = runtimeService.createExecutionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : list) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">reason</span> <span class="operator">=</span> runtimeService.getVariable(execution.getId(), <span class="string">&quot;reason&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;execution name：&#123;&#125;,reason:&#123;&#125;&quot;</span>, execution.getName(), reason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询流程执行实例 ID 对应的所有变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据流程执行实例 ID 查询所有对应的流程变量：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * select * from ACT_RU_VARIABLE WHERE EXECUTION_ID_ = ? AND TASK_ID_ is null</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; list = runtimeService.createExecutionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : list) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; variables = runtimeService.getVariables(execution.getId());</span><br><span class="line">        logger.info(<span class="string">&quot;variables:&#123;&#125;&quot;</span>, variables);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过-Task-设置"><a href="#通过-Task-设置" class="headerlink" title="通过 Task 设置"></a>通过 Task 设置</h3><p>给 Task 设置流程变量分两种：</p>
<ul>
<li>逐个设置</li>
<li>通过 Map 批量设置</li>
</ul>
<p>无论是哪种方式，本质上都还是往 <code>ACT_RU_VARABLE</code>和 <code>ACT_HI_VARINST</code>表中插入数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 我们也可以根据 task 去查询流程变量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().taskAssignee(<span class="string">&quot;javaboy&quot;</span>).singleResult();</span><br><span class="line">    <span class="comment">//这里即会根据 taskId 去查询，也会根据 taskId 对应的执行实例 id 去查询</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">a</span> <span class="operator">=</span> taskService.getVariable(task.getId(), <span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="comment">//这里也是先根据 taskId 先找到执行实例 id，然后根据执行实例的 id 去进行查询</span></span><br><span class="line">    <span class="comment">//select * from ACT_RU_VARIABLE WHERE EXECUTION_ID_ = ? AND TASK_ID_ is null</span></span><br><span class="line">    Map&lt;String, Object&gt; variables = taskService.getVariables(task.getId());</span><br><span class="line">    logger.info(<span class="string">&quot;a:&#123;&#125;,variables:&#123;&#125;&quot;</span>, a, variables);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过 Task 来设置流程变量</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 通过 Task 设置，也是插入到两个地方：</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 1. ACT_HI_VARINST</span></span><br><span class="line"><span class="comment"> * 2. ACT_RU_VARIABLE</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 在设置的时候，虽然需要传递 TaskId，但是并不是说这个变量跟当前 Task 绑定，通过这个 taskId 可以查询出来这个 Task 对应的 流程实例 id 和执行实例 id，将来插入的时候会用到</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().taskAssignee(<span class="string">&quot;javaboy&quot;</span>).singleResult();</span><br><span class="line">    logger.info(<span class="string">&quot;taskId:&#123;&#125;&quot;</span>, task.getId());</span><br><span class="line">    <span class="comment">//第一个参数是 taskId，后面则是流程变量的 key-value</span></span><br><span class="line">    taskService.setVariable(task.getId(), <span class="string">&quot;result&quot;</span>, <span class="string">&quot;同意&quot;</span>);</span><br><span class="line">    Map&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    vars.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">    vars.put(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line">    <span class="comment">//批量设置流程变量</span></span><br><span class="line">    taskService.setVariables(task.getId(), vars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="完成任务时设置"><a href="#完成任务时设置" class="headerlink" title="完成任务时设置"></a>完成任务时设置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成任务时设置流程变量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 由于流程要执行结束了，因此 ACT_RU_VARIABLE 表要被清空了，所以这里就只向 ACT_HI_VARINST 表中保存数据。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery().taskAssignee(<span class="string">&quot;javaboy&quot;</span>).singleResult();</span><br><span class="line">    Map&lt;String, Object&gt; vars = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    vars.put(<span class="string">&quot;state&quot;</span>, <span class="string">&quot;完成&quot;</span>);</span><br><span class="line">    taskService.complete(task.getId(),vars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="通过流程来设置"><a href="#通过流程来设置" class="headerlink" title="通过流程来设置"></a>通过流程来设置</h4><p>可以从流程实例的角度来设置全局的流程变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 由于流程变量是和当前流程实例相关的，所以流程变量也可以直接通过流程实例来设置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test07</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Execution&gt; list = runtimeService.createExecutionQuery().list();</span><br><span class="line">    <span class="keyword">for</span> (Execution execution : list) &#123;</span><br><span class="line">        runtimeService.setVariable(execution.getId(), <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://lcdzzz.github.io">lcdzzz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://lcdzzz.github.io/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/">http://lcdzzz.github.io/2022/10/01/%E5%B7%A5%E4%BD%9C%E6%B5%81/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://lcdzzz.github.io" target="_blank">布鲁成周勒的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/tienchin/">tienchin</a><a class="post-meta__tags" href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a><a class="post-meta__tags" href="/tags/flowable/">flowable</a></div><div class="post-share"><div class="social-share" data-image="https://lcdzzz.github.io/2022/10/01/gong-zuo-liu/1662298798529-e1bcda3a-42fe-4d7b-8b42-a1a38cd3c654.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2022/10/19/%E5%85%B3%E4%BA%8Ejava%E7%9A%84Calendar%E7%B1%BB%E7%9A%84bug/" title="关于java的Calendar类的bug"><img class="cover" src="https://img2.baidu.com/it/u=1334167515,3225602473&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPG?w=658&amp;h=494" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">关于java的Calendar类的bug</div></div><div class="info-2"><div class="info-item-1"> 这篇文章废话比较多，想看bug和本人的逆天操作的话，可以直接去看“解决办法”和“结论”部分  起源一切的一切都起源于软测这一道看似无比简单的题    .wlepixipfqrd{width:70%}   简单来说就是输出20221019这样的格式，然后输出是星期几 错误的代码这是我最开始写的错误的代码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110import java.util.*;public class day &#123;    public static void main(String[] args) &#123;        Scanner in = new Scanne...</div></div></div></a><a class="pagination-related" href="/2022/08/01/SpringSecurity%E9%9A%8F%E8%AE%B0/" title="SpringSecurity"><img class="cover" src="https://images.wallpaperscraft.com/image/single/spruce_art_forest_131371_300x168.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">SpringSecurity</div></div><div class="info-2"><div class="info-item-1">SpringSecurity完成基于数据库的认证（登录） application.yml配置 12345678910spring:  datasource:        name: test        url: jdbc:mysql://localhost:3306/javaboy?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai        username: root        password: wqeq        # 使用druid数据源        type: com.alibaba.druid.pool.DruidDataSource        driver-class-name: com.mysql.cj.jdbc.Driver  mysql,mybatis,druid依赖必须有 123456789101112131415&lt;dependency&gt;          &lt;groupId&gt;org.mybatis.spring...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2022/06/02/tienchin%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" title="tienchin项目笔记"><img class="cover" src="https://img2.baidu.com/it/u=2535873879,22375097&fm=253&fmt=auto&app=138&f=JPEG?w=900&h=448" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-02</div><div class="info-item-2">tienchin项目笔记</div></div><div class="info-2"><div class="info-item-1">项目结构分析项目结构：多模块（不是微服务） 整体思路：  依赖链最底层：common，提供了公用的工具，定义了统一的controller，BaseEntity实体类公共对象，以及其他的操作工具 common的上一层：framework，主要是配置类，在这里配置了系统的一些东西，例如security aop 数据源的配置等等 剩下的对应了三个的功能模块 system：系统管理，相等于具体的业务。比如系统管理中的用户管理，角色管理，菜单管理等等，包括系统监控什么的，都是写在system里面的 generator：代码生成 quartz：定时任务   ui：前端项目 admin：项目唯一的统一入口，controller都是在这里写的，上面的common等，都会被admin所依赖，这里的controller会调用对应的service  登录验证码响应结果分析： Base64字符串转图片：https://tool.jisuapi.com/base642pic.html 验证码生成接口分析： url：localhost/dev-api/captchaImage AjaxResult是一个封装...</div></div></div></a><a class="pagination-related" href="/2024/02/03/%E5%A4%84%E7%90%86%E5%B9%82%E7%AD%89%E6%80%A7/" title="处理幂等性"><img class="cover" src="https://img0.baidu.com/it/u=3422995933,1192011804&fm=253&fmt=auto&app=138&f=JPEG?w=589&h=220" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-03</div><div class="info-item-2">处理幂等性</div></div><div class="info-2"><div class="info-item-1"> 代码地址 ruoyi脚手架是通过参数去判断：  把请求缓存起来到redis里面去【请求地址、请求参数…】 比如：请求地址和请求参数都是一样的话，10秒只能就拒绝重复提交  但这个方法存在一个问题：如果请求的参数是json，一旦我提取出来，将来在接口里面就提取不到了，所以我们先要把这个问题解决掉  **所需依赖：**springweb、redis、aop 1234567891011121314151617181920&lt;dependencies&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt...</div></div></div></a><a class="pagination-related" href="/2024/01/28/%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E6%B3%A8%E8%A7%A3/" title="自定义限流注解"><img class="cover" src="https://img1.baidu.com/it/u=1262509061,4086244529&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=339" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-28</div><div class="info-item-2">自定义限流注解</div></div><div class="info-2"><div class="info-item-1"> 代码地址  依赖依赖：springweb、nosql的redis、aop 123456789101112&lt;dependency&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starte...</div></div></div></a><a class="pagination-related" href="/2022/06/18/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/" title="自定义多数据源"><img class="cover" src="https://img0.baidu.com/it/u=3276317046,1367389085&fm=253&fmt=auto&app=138&f=PNG?w=889&h=500" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-18</div><div class="info-item-2">自定义多数据源</div></div><div class="info-2"><div class="info-item-1">  项目地址  准备依赖：  Web  Spring Web   SQL  MyBatis Framework MySQL Driver   关于@Retention注解作用可以看这个  @Target:注解的作用目标   配置文件 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556# 数据源配置spring:  datasource:    type: com.alibaba.druid.pool.DruidDataSource    driverClassName: com.mysql.cj.jdbc.Driver    ds:      # 主库数据源      master:        url: jdbc:mysql://localhost:3306/test01?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertT...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">lcdzzz</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81workflow"><span class="toc-number">1.</span> <span class="toc-text">工作流workflow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA%E8%A7%A3%E5%86%B3%E6%B5%81%E7%A8%8B%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">状态机解决流程问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%A4%8D%E6%9D%82%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">一些复杂的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%A5%E9%94%80%E5%AE%A1%E6%89%B9%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">报销审批的流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%94%B5%E8%84%91%E7%94%9F%E4%BA%A7%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">笔记本电脑生产流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%A4%A7%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="toc-number">1.2.</span> <span class="toc-text">三大工作流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.3.</span> <span class="toc-text">流程图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BPMN%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%80%8E%E4%B9%88%E7%94%BB"><span class="toc-number">1.4.</span> <span class="toc-text">BPMN流程图怎么画</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E7%BA%BF"><span class="toc-number">1.4.2.</span> <span class="toc-text">连线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.4.3.</span> <span class="toc-text">任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3"><span class="toc-number">1.4.4.</span> <span class="toc-text">网关</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%BB%98%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">流程图绘制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#flowable-bpmn-visualizer"><span class="toc-number">2.0.1.</span> <span class="toc-text">flowable-bpmn-visualizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flowable-ui"><span class="toc-number">2.0.2.</span> <span class="toc-text">flowable-ui</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">2.0.2.3.</span> <span class="toc-text">功能模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E7%AE%A1%E7%90%86%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.0.2.4.</span> <span class="toc-text">身份管理应用程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.0.2.5.</span> <span class="toc-text">管理员应用程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E6%A8%A1%E5%99%A8%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.0.2.6.</span> <span class="toc-text">建模器应用程序</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">2.0.2.6.1.</span> <span class="toc-text">绘制流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E9%97%AE%E9%A2%98"><span class="toc-number">2.0.2.6.2.</span> <span class="toc-text">表单问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E4%BA%BA"><span class="toc-number">2.0.2.6.3.</span> <span class="toc-text">任务处理人</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.0.2.6.4.</span> <span class="toc-text">基本概念</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.0.2.7.</span> <span class="toc-text">任务应用程序</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flowable-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91"><span class="toc-number">3.</span> <span class="toc-text">Flowable 源码编译</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#H2-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.0.1.</span> <span class="toc-text">H2 数据库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">简单使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C"><span class="toc-number">4.1.</span> <span class="toc-text">用户操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E"><span class="toc-number">4.1.1.</span> <span class="toc-text">增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9"><span class="toc-number">4.1.2.</span> <span class="toc-text">改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0"><span class="toc-number">4.1.3.</span> <span class="toc-text">删</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5"><span class="toc-number">4.1.4.</span> <span class="toc-text">查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BB%84%E6%93%8D%E4%BD%9C"><span class="toc-number">4.2.</span> <span class="toc-text">用户组操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">删</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5-1"><span class="toc-number">4.2.4.</span> <span class="toc-text">查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%B5%81%E7%A8%8B%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">流程定义与流程实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89-ProcessDefinition"><span class="toc-number">5.1.</span> <span class="toc-text">流程定义 ProcessDefinition</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.1.</span> <span class="toc-text">自动部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.2.</span> <span class="toc-text">手动部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2-1"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">手动部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">查询流程定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">查询流程部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4"><span class="toc-number">5.1.2.4.</span> <span class="toc-text">流程定义删除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9E%E4%BE%8B-Process-Instance"><span class="toc-number">5.2.</span> <span class="toc-text">流程实例 Process Instance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">启动流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%B5%81%E7%A8%8B%E6%98%AF%E5%90%A6%E7%BB%93%E6%9D%9F"><span class="toc-number">5.2.2.</span> <span class="toc-text">查看流程是否结束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%90%E8%A1%8C%E7%9A%84%E6%B4%BB%E5%8A%A8%E8%8A%82%E7%82%B9"><span class="toc-number">5.2.3.</span> <span class="toc-text">查看运行的活动节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%B5%81%E7%A8%8B%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.2.4.</span> <span class="toc-text">删除流程实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E7%9A%84%E6%8C%82%E8%B5%B7%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">5.3.</span> <span class="toc-text">流程的挂起和恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">5.3.1.</span> <span class="toc-text">流程定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.3.2.</span> <span class="toc-text">流程实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DataObject"><span class="toc-number">5.4.</span> <span class="toc-text">DataObject</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flowable-%E4%B8%AD%E7%9A%84%E7%A7%9F%E6%88%B7"><span class="toc-number">5.5.</span> <span class="toc-text">Flowable 中的租户</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E4%BB%BB%E5%8A%A1"><span class="toc-number">6.</span> <span class="toc-text">流程任务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UserTask"><span class="toc-number">6.1.</span> <span class="toc-text">UserTask</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%8D%95%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="toc-number">6.1.1.</span> <span class="toc-text">设置单个用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A%E5%85%B7%E4%BD%93%E7%94%A8%E6%88%B7"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">直接指定具体用户</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE%E7%BB%99%E5%85%B6%E4%BB%96%E4%BA%BA"><span class="toc-number">6.1.1.1.1.</span> <span class="toc-text">委派给其他人</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E8%87%AA%E5%B7%B1%E5%A4%84%E7%90%86%E4%BA%86"><span class="toc-number">6.1.1.1.2.</span> <span class="toc-text">直接自己处理了</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8F%98%E9%87%8F%E6%9D%A5%E8%AE%BE%E7%BD%AE"><span class="toc-number">6.1.1.2.</span> <span class="toc-text">通过变量来设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%9B%91%E5%90%AC%E5%99%A8%E6%9D%A5%E8%AE%BE%E7%BD%AE"><span class="toc-number">6.1.1.3.</span> <span class="toc-text">通过监听器来设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BA%E6%B5%81%E7%A8%8B%E7%9A%84%E5%8F%91%E8%B5%B7%E4%BA%BA"><span class="toc-number">6.1.1.4.</span> <span class="toc-text">设置为流程的发起人</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%A4%9A%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="toc-number">6.1.2.</span> <span class="toc-text">设置多个用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">直接指定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F%E6%88%96%E8%80%85%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">使用变量或者监听器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">6.1.2.2.1.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.1.2.2.2.</span> <span class="toc-text">监听器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%9B%9E%E9%80%80"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">任务回退</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%80%99%E9%80%89%E4%BA%BA%E7%9A%84%E6%B7%BB%E5%8A%A0%E4%B8%8E%E5%88%A0%E9%99%A4"><span class="toc-number">6.1.2.4.</span> <span class="toc-text">流程候选人的添加与删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E7%85%A7%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E4%BA%BA"><span class="toc-number">6.1.3.</span> <span class="toc-text">按照角色分配任务处理人</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8F%98%E9%87%8F%E6%9D%A5%E6%8C%87%E5%AE%9A"><span class="toc-number">6.1.3.0.1.</span> <span class="toc-text">通过变量来指定</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceTask"><span class="toc-number">6.2.</span> <span class="toc-text">ServiceTask</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E7%B1%BB"><span class="toc-number">6.2.1.</span> <span class="toc-text">监听类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E7%B1%BB%E8%AE%BE%E7%BD%AE%E5%AD%97%E6%AE%B5"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">为类设置字段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A7%94%E6%89%98%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">6.2.2.</span> <span class="toc-text">委托表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">6.2.3.</span> <span class="toc-text">表达式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ScriptTask"><span class="toc-number">6.3.</span> <span class="toc-text">ScriptTask</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript"><span class="toc-number">6.3.1.</span> <span class="toc-text">JavaScript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Groovy"><span class="toc-number">6.3.2.</span> <span class="toc-text">Groovy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Juel"><span class="toc-number">6.3.3.</span> <span class="toc-text">Juel</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E5%85%B3-1"><span class="toc-number">7.</span> <span class="toc-text">网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E4%BB%96%E7%BD%91%E5%85%B3"><span class="toc-number">7.1.</span> <span class="toc-text">排他网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E7%BD%91%E5%85%B3"><span class="toc-number">7.2.</span> <span class="toc-text">并行网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%85%E5%AE%B9%E7%BD%91%E5%85%B3"><span class="toc-number">7.3.</span> <span class="toc-text">包容网关</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%8F%98%E9%87%8F"><span class="toc-number">8.</span> <span class="toc-text">流程变量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%B5%81%E7%A8%8B%E5%8F%98%E9%87%8F"><span class="toc-number">8.1.</span> <span class="toc-text">全局流程变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%97%B6%E5%80%99%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.1.</span> <span class="toc-text">启动时候设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-Task-%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.2.</span> <span class="toc-text">通过 Task 设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%88%90%E4%BB%BB%E5%8A%A1%E6%97%B6%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.3.</span> <span class="toc-text">完成任务时设置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B5%81%E7%A8%8B%E6%9D%A5%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.3.1.</span> <span class="toc-text">通过流程来设置</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/23/%E6%9E%9A%E4%B8%BE%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%9B%9B%E7%A7%8D%E5%86%99%E6%B3%95/" title="枚举转换的四种写法">枚举转换的四种写法</a><time datetime="2026-01-23T08:03:12.000Z" title="发表于 2026-01-23 16:03:12">2026-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/04/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%92%8C%E5%BF%AB%E9%80%9F%E9%80%89%E6%8B%A9/" title="快速排序和快速选择"><img src="https://img2.baidu.com/it/u=924906505,2741718824&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=250" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="快速排序和快速选择"/></a><div class="content"><a class="title" href="/2026/01/04/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%92%8C%E5%BF%AB%E9%80%9F%E9%80%89%E6%8B%A9/" title="快速排序和快速选择">快速排序和快速选择</a><time datetime="2026-01-04T08:56:59.000Z" title="发表于 2026-01-04 16:56:59">2026-01-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/31/windows%E3%81%AEwsl%E5%AE%89%E8%A3%85centos/" title="windowsのwsl安装centos"><img src="https://img0.baidu.com/it/u=4198488413,3086794076&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=501&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="windowsのwsl安装centos"/></a><div class="content"><a class="title" href="/2025/07/31/windows%E3%81%AEwsl%E5%AE%89%E8%A3%85centos/" title="windowsのwsl安装centos">windowsのwsl安装centos</a><time datetime="2025-07-30T16:25:54.000Z" title="发表于 2025-07-31 00:25:54">2025-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/23/GaussDB%E5%AE%89%E8%A3%85%E5%8F%8A%E5%BA%94%E7%94%A8/" title="GaussDB安装及应用"><img src="https://img2.baidu.com/it/u=1042180318,3822666887&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=565&amp;h=330" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GaussDB安装及应用"/></a><div class="content"><a class="title" href="/2024/11/23/GaussDB%E5%AE%89%E8%A3%85%E5%8F%8A%E5%BA%94%E7%94%A8/" title="GaussDB安装及应用">GaussDB安装及应用</a><time datetime="2024-11-23T14:52:15.000Z" title="发表于 2024-11-23 22:52:15">2024-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/30/prometheus-consul-blackboxTest/" title="prometheus&amp;consul&amp;blackboxTest"><img src="https://lcdzzz.github.io/2022/05/11/pictures/prometheus.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="prometheus&amp;consul&amp;blackboxTest"/></a><div class="content"><a class="title" href="/2024/09/30/prometheus-consul-blackboxTest/" title="prometheus&amp;consul&amp;blackboxTest">prometheus&amp;consul&amp;blackboxTest</a><time datetime="2024-09-30T09:03:24.000Z" title="发表于 2024-09-30 17:03:24">2024-09-30</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By lcdzzz</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天" style="display:none"><i class="fas fa-message"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script>(() => {
  window.ChatraID = ''
  window.Chatra = window.Chatra || function() {
    (window.Chatra.q = window.Chatra.q || []).push(arguments)
  }

  btf.getScript('https://call.chatra.io/chatra.js').then(() => {
    const isChatBtn = true
    const isChatHideShow = true

    if (isChatBtn) {
      const close = () => {
        Chatra('minimizeWidget')
        Chatra('hide')
      }

      const open = () => {
        Chatra('openChat', true)
        Chatra('show')
      }

      window.ChatraSetup = { startHidden: true }
    
      window.chatBtnFn = () => document.getElementById('chatra').classList.contains('chatra--expanded') ? close() : open()

      document.getElementById('chat-btn').style.display = 'block'
    } else if (isChatHideShow) {
      window.chatBtn = {
        hide: () => Chatra('hide'),
        show: () => Chatra('show')
      }
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>